"use strict";(self.webpackChunk_coreui_coreui_free_react_admin_template=self.webpackChunk_coreui_coreui_free_react_admin_template||[]).push([[7009],{67009:function(e,s,l){l.r(s);var t=l(9950),n=l(49911),a=l(2720),o=l(44414);s.default=()=>{const[e,s]=(0,t.useState)(""),[c,r]=(0,t.useState)(""),[i,d]=(0,t.useState)(1),[u,m]=(0,t.useState)(20),[h,g]=(0,t.useState)(""),[p,x]=(0,t.useState)(""),[b,j]=(0,t.useState)("All"),[f,v]=(0,t.useState)("All"),[C,y]=(0,t.useState)([]),[U,_]=(0,t.useState)(!1),[I,N]=(0,t.useState)(!1),[A,L]=(0,t.useState)(null),[S,w]=(0,t.useState)([]),[T,R]=(0,t.useState)(0),[F,D]=(0,t.useState)([]),[E,k]=(0,t.useState)(0),[O,P]=(0,t.useState)(!1);(0,t.useEffect)(()=>{(async()=>{try{const e=await(0,a.H2)("/v1/user/details","GET"),l=e.user||e.data||e;l&&l._id&&s(l._id),l&&l.businessId&&r(l.businessId)}catch(e){}})()},[]),(0,t.useEffect)(()=>{(async()=>{if(c){_(!0);try{const e=await(0,a.H2)("/branch/".concat(c,"/branches"),"GET");let s=[];s=Array.isArray(e)?e:Array.isArray(e.data)?e.data:Array.isArray(e.branches)?e.branches:[];const l=[];s.forEach(e=>{const s=e.user||e.manager||null;s&&(s._id||s.id)&&l.push({_id:s._id||s.id,name:s.name||s.fullName||s.email||e.branchName||"Agent ".concat(s._id||s.id),email:s.email||""})});const t={},n=l.filter(e=>!!e._id&&(!t[e._id]&&(t[e._id]=!0,!0)));y(n)}catch(e){console.error("Failed to fetch agents for business",e),y([])}finally{_(!1)}}})()},[c]);const $=async function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(L(null),e){if(!c)try{const e=await(0,a.H2)("/v1/user/details","GET"),s=e.user||e.data||e;if(!s||!s.businessId)return void L("Business ID not found for current user. Please ensure you are logged in.");r(s.businessId)}catch(n){return void L("Unable to determine business id from current user details")}N(!0);try{const l="undefined"!==typeof s.page?s.page:i,t="undefined"!==typeof s.limit?s.limit:u,n=[];if(n.push("businessId=".concat(encodeURIComponent(c))),n.push("logsPage=".concat(encodeURIComponent(l))),n.push("logsLimit=".concat(encodeURIComponent(t))),h&&n.push("from=".concat(encodeURIComponent(h))),p&&n.push("to=".concat(encodeURIComponent(p))),b&&"All"!==b){const e="Outgoing"===b?"outbound":"Incoming"===b?"inbound":b;n.push("callType=".concat(encodeURIComponent(e))),n.push("type=".concat(encodeURIComponent(e))),n.push("call_type=".concat(encodeURIComponent(e)))}if(f&&"All"!==f){const e=f.toLowerCase();n.push("status=".concat(encodeURIComponent(e))),n.push("callStatus=".concat(encodeURIComponent(e))),n.push("call_status=".concat(encodeURIComponent(e)))}const o="/call-uses/user/".concat(encodeURIComponent(e),"/with-logs?").concat(n.join("&")),r=await(0,a.H2)(o,"GET"),g=r.callUses||[];let x=Array.isArray(r.callLogs)?r.callLogs:[];if(b&&"All"!==b){const e="Outgoing"===b?"outbound":"Incoming"===b?"inbound":b.toLowerCase();x=x.filter(s=>String(s.callType||"").toLowerCase()===e)}if(f&&"All"!==f){const e=String(f).toLowerCase();x=x.filter(s=>String(s.status||"").toLowerCase()===e)}if(h){const e=new Date(h);x=x.filter(s=>{const l=new Date(s.callDate||s.createdAt||s.contactedOn||null);return!isNaN(l)&&l>=e})}if(p){const e=new Date(p);e.setHours(23,59,59,999),x=x.filter(s=>{const l=new Date(s.callDate||s.createdAt||s.contactedOn||null);return!isNaN(l)&&l<=e})}w(g),R(r.callUsesCount||g.length),D(x),k(x.length),d(l),m(t)}catch(n){var l,t;console.error("Failed to fetch call uses",n),L((null===n||void 0===n||null===(l=n.response)||void 0===l||null===(t=l.data)||void 0===t?void 0:t.message)||n.message||"Failed to load data"),w([]),D([])}finally{N(!1)}}else L("Please provide an agent User ID")};return(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{className:"d-flex justify-content-between align-items-center mb-4",children:(0,o.jsx)("h1",{className:"h3",children:"Call Uses"})}),(0,o.jsx)(n.E$,{className:"mb-4",children:(0,o.jsxs)(n.W6,{children:[(0,o.jsxs)(n.sK,{className:"mb-3",children:[(0,o.jsxs)(n.UF,{md:6,className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"Agent"}),(0,o.jsxs)(n.MT,{value:e,onChange:e=>{const l=e.target.value;s(l),w([]),D([]),R(0),k(0),L(null),d(1)},children:[(0,o.jsx)("option",{value:"",children:"-- Select agent --"}),U?(0,o.jsx)("option",{value:"",children:"Loading agents..."}):C.map(e=>(0,o.jsx)("option",{value:e._id,children:e.name||e.email||e._id},e._id))]})]}),(0,o.jsx)(n.UF,{md:6,className:"d-flex align-items-end gap-2 justify-content-end",children:(0,o.jsx)(n.Q_,{color:"primary",onClick:$,disabled:I||!e,children:I?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.JT,{size:"sm"}),"\xa0Loading"]}):"Load"})})]}),A&&(0,o.jsx)("div",{className:"text-danger mb-3",children:A}),(0,o.jsx)(n.sK,{className:"mb-3",children:(0,o.jsxs)(n.UF,{children:[(0,o.jsx)("h5",{children:"Summary"}),I?(0,o.jsx)(n.JT,{}):0===S.length?(0,o.jsx)("div",{className:"text-muted",children:"No call uses found for the selected agent."}):S.map(e=>{var s;return(0,o.jsx)(n.E$,{className:"mb-2",children:(0,o.jsx)(n.W6,{children:(0,o.jsxs)("div",{className:"d-flex justify-content-between",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"Number:"})," ",(null===(s=e.numberId)||void 0===s?void 0:s.number)||"\u2014",(0,o.jsx)("br",{}),(0,o.jsx)("strong",{children:"Outbound:"})," ",e.outboundCalls," \xa0 ",(0,o.jsx)("strong",{children:"Inbound:"})," ",e.inboundCalls]}),(0,o.jsxs)("div",{className:"text-end text-muted",children:[(0,o.jsxs)("div",{children:["Created: ",new Date(e.createdAt).toLocaleString()]}),(0,o.jsxs)("div",{children:["Updated: ",new Date(e.updatedAt).toLocaleString()]})]})]})})},e._id)})]})}),(0,o.jsxs)(n.sK,{className:"align-items-center mb-2",children:[(0,o.jsxs)(n.UF,{md:2,className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"Logs page"}),(0,o.jsx)(n.MT,{value:i,onChange:e=>d(Number(e.target.value)),children:Array.from({length:10}).map((e,s)=>(0,o.jsx)("option",{value:s+1,children:s+1},s))})]}),(0,o.jsxs)(n.UF,{md:2,className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"Logs limit"}),(0,o.jsx)(n.MT,{value:u,onChange:e=>m(Number(e.target.value)),children:[10,20,50,100].map(e=>(0,o.jsx)("option",{value:e,children:e},e))})]}),(0,o.jsxs)(n.UF,{md:2,className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"From"}),(0,o.jsx)(n.OG,{type:"date",value:h,onChange:e=>g(e.target.value)})]}),(0,o.jsxs)(n.UF,{md:2,className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"To"}),(0,o.jsx)(n.OG,{type:"date",value:p,onChange:e=>x(e.target.value)})]}),(0,o.jsxs)(n.UF,{md:2,className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"Call Type"}),(0,o.jsx)(n.MT,{value:b,onChange:e=>j(e.target.value),children:["All","Incoming","Outgoing"].map(e=>(0,o.jsx)("option",{value:e,children:e},e))})]}),(0,o.jsxs)(n.UF,{md:2,className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"Status"}),(0,o.jsx)(n.MT,{value:f,onChange:e=>v(e.target.value),children:["All","Completed","Failed"].map(e=>(0,o.jsx)("option",{value:e,children:e},e))})]})]}),(0,o.jsxs)(n.sK,{className:"align-items-center mb-2",children:[(0,o.jsxs)(n.UF,{md:6,className:"mb-2 d-flex gap-2",children:[(0,o.jsx)(n.Q_,{color:"primary",onClick:async()=>{await $({page:1})},disabled:I,children:I?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.JT,{size:"sm"}),"\xa0Loading"]}):"Apply Filters"}),(0,o.jsx)(n.Q_,{color:"secondary",onClick:async()=>{g(""),x(""),j("All"),v("All"),await $({page:1,limit:20})},disabled:I,children:"Clear Filters"}),(0,o.jsx)(n.Q_,{color:"info",onClick:$,disabled:I||!e,children:"Refresh Logs"}),(0,o.jsx)(n.Q_,{color:"success",onClick:async()=>{if(L(null),e){(!S||0===S.length)&&(!F||F.length),P(!0);try{if(!c)try{const e=await(0,a.H2)("/v1/user/details","GET"),s=e.user||e.data||e;if(!s||!s.businessId)return L("Business ID not found for current user. Please ensure you are logged in."),void P(!1);r(s.businessId)}catch(s){return L("Unable to determine business id from current user details"),void P(!1)}const n=e=>{var s,l;const t=e&&e.data?e.data.data||e.data:e||{};return{callLogs:t.callLogs||t.logs||(null===(s=t.data)||void 0===s?void 0:s.callLogs)||[],callLogsCount:t.callLogsCount||t.logsCount||t.total||0,logsLimit:t.logsLimit||t.logs_limit||t.limit||0,logsPage:t.logsPage||t.page||1,callUses:t.callUses||t.uses||(null===(l=t.data)||void 0===l?void 0:l.callUses)||[],callUsesCount:t.callUsesCount||t.usesCount||0}},o="/call-uses/user/".concat(encodeURIComponent(e),"/with-logs");let i=1;const d=E&&E>0?E:Math.max(u,1e3),m=[];let g=[],x=null,j=d;const v=500;for(;i<=v;){const e=[];if(e.push("businessId=".concat(encodeURIComponent(c))),e.push("logsPage=".concat(i)),e.push("logsLimit=".concat(d)),h&&e.push("from=".concat(encodeURIComponent(h))),p&&e.push("to=".concat(encodeURIComponent(p))),b&&"All"!==b){const s="Outgoing"===b?"outbound":"Incoming"===b?"inbound":b;e.push("callType=".concat(encodeURIComponent(s))),e.push("type=".concat(encodeURIComponent(s))),e.push("call_type=".concat(encodeURIComponent(s)))}if(f&&"All"!==f){const s=f.toLowerCase();e.push("status=".concat(encodeURIComponent(s))),e.push("callStatus=".concat(encodeURIComponent(s))),e.push("call_status=".concat(encodeURIComponent(s)))}const s="".concat(o,"?").concat(e.join("&"));let l;try{l=await(0,a.H2)(s,"GET")}catch(t){console.warn("Failed to fetch export page",i,t);break}const r=n(l);1===i&&(g=r.callUses&&r.callUses.length?r.callUses:g,x=r.callLogsCount||(Array.isArray(r.callLogs)?r.callLogs.length:null)||x,j=r.logsLimit&&r.logsLimit>0?r.logsLimit:j);const u=Array.isArray(r.callLogs)?r.callLogs:[];if(u.length>0&&m.push(...u),console.debug("CallUses export - page ".concat(i," returned ").concat(u.length," logs")),x&&m.length>=x||j&&u.length<j)break;if(!j&&0===u.length)break;i+=1}let C=m&&m.length?m:F&&F.length?F:[];console.debug("CallUses export - final counts -> summary:",g&&g.length||0,"logs:",C.length,"collected:",m.length,"expectedTotal:",x);try{console.debug("CallUses export - collectedLogs:",m.length,"expectedTotal:",x,"perPage:",j)}catch(s){}let y=null;try{y=await l.e(5271).then(l.bind(l,55271))}catch(s){return console.error("xlsx import failed",s),L('Export failed: xlsx library is not available. Please install "xlsx" dependency.'),void P(!1)}const U=y&&(y.default||y);let _=null;try{_=await l.e(4691).then(l.t.bind(l,34691,23))}catch(s){return console.error("file-saver import failed",s),L('Export failed: file-saver library is not available. Please install "file-saver" dependency.'),void P(!1)}const I=_.saveAs||_.default||_&&_,N=(g||[]).map(e=>{var s,l,t,n,a;return{number:(null===(s=e.numberId)||void 0===s?void 0:s.number)||e.number||"",outboundCalls:null!==(l=e.outboundCalls)&&void 0!==l?l:"",inboundCalls:null!==(t=e.inboundCalls)&&void 0!==t?t:"",missedCalls:null!==(n=e.missedCalls)&&void 0!==n?n:"",hangCalls:null!==(a=e.hangCalls)&&void 0!==a?a:"",createdAt:e.createdAt||e.created_at||"",updatedAt:e.updatedAt||e.updated_at||""}}),A=(C||[]).map(e=>{var s,l,t;return{id:e._id||e.id||"",date:e.callDate||e.contactedOn||e.createdAt||"",contact:e.contact||e.callReceivedBy||"",virtualNumber:e.virtualNumber||e.number||e.numberId&&e.numberId.number||"",duration:null!==(s=null!==(l=e.callDuration)&&void 0!==l?l:e.duration)&&void 0!==s?s:"",type:e.callType||"",status:e.status||"",notes:e.notes||"",cost:null!==(t=e.cost)&&void 0!==t?t:""}}),S=U.utils.book_new(),w=U.utils.json_to_sheet(N),T=U.utils.json_to_sheet(A);U.utils.book_append_sheet(S,w,"Summary"),U.utils.book_append_sheet(S,T,"Logs");const R=U.write(S,{bookType:"xlsx",type:"array"}),D=new Blob([R],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8"});I(D,"calluses_".concat(e,"_").concat((new Date).toISOString().slice(0,10),".xlsx"))}catch(t){console.error("Export failed",t),L("Export failed. See console for details.")}finally{P(!1)}}else L("Please select an agent before exporting")},disabled:O||!e,children:O?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.JT,{size:"sm"}),"\xa0Exporting"]}):"Export Excel"})]}),(0,o.jsx)(n.UF,{md:6,className:"mb-2",children:(0,o.jsxs)("div",{className:"text-end text-muted",children:["Total logs: ",(0,o.jsx)("strong",{children:E})]})})]}),(0,o.jsx)(n.sK,{children:(0,o.jsx)(n.UF,{children:(0,o.jsxs)(n._v,{hover:!0,responsive:!0,children:[(0,o.jsx)(n.wV,{children:(0,o.jsxs)(n.YI,{children:[(0,o.jsx)(n.$s,{children:"Date"}),(0,o.jsx)(n.$s,{children:"Contact"}),(0,o.jsx)(n.$s,{children:"Virtual Number"}),(0,o.jsx)(n.$s,{children:"Duration (s)"}),(0,o.jsx)(n.$s,{children:"Type"}),(0,o.jsx)(n.$s,{children:"Status"}),(0,o.jsx)(n.$s,{children:"Notes"})]})}),(0,o.jsx)(n.jS,{children:I?(0,o.jsx)(n.YI,{children:(0,o.jsx)(n.cC,{colSpan:7,className:"text-center",children:(0,o.jsx)(n.JT,{})})}):0===F.length?(0,o.jsx)(n.YI,{children:(0,o.jsx)(n.cC,{colSpan:7,className:"text-center text-muted",children:"No call logs"})}):F.map(e=>{var s,l;return(0,o.jsxs)(n.YI,{children:[(0,o.jsx)(n.cC,{children:new Date(e.callDate||e.createdAt).toLocaleString()}),(0,o.jsx)(n.cC,{children:e.contact||e.callReceivedBy||"\u2014"}),(0,o.jsx)(n.cC,{children:e.virtualNumber||e.number||e.numberId&&e.numberId.number||"\u2014"}),(0,o.jsx)(n.cC,{children:null!==(s=null!==(l=e.callDuration)&&void 0!==l?l:e.duration)&&void 0!==s?s:"\u2014"}),(0,o.jsx)(n.cC,{children:(0,o.jsx)(n.$X,{color:"outbound"===e.callType?"primary":"success",children:e.callType})}),(0,o.jsx)(n.cC,{children:e.status}),(0,o.jsx)(n.cC,{children:e.notes||"\u2014"})]},e._id)})})]})})})]})})]})}}}]);