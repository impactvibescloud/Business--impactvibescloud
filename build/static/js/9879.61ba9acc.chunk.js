"use strict";(self.webpackChunk_coreui_coreui_free_react_admin_template=self.webpackChunk_coreui_coreui_free_react_admin_template||[]).push([[9879],{19879:function(e,i,n){n.r(i);var a=n(9950),l=n(49911),d=n(2720),o=n(4695),s=n.n(o),t=n(11031),r=n(44414);i.default=()=>{const[e,i]=(0,a.useState)({}),[n,o]=(0,a.useState)([]),[c,u]=(0,a.useState)(!0),[v,m]=(0,a.useState)({}),[h,f]=(0,a.useState)([]),[b,x]=(0,a.useState)([]),[w,p]=(0,a.useState)([]),[g,N]=(0,a.useState)({}),y=(0,t.g)();(0,a.useEffect)(()=>{if(!y)return;(async()=>{try{var e;const n=await(0,d.H2)("/v1/user/details","GET"),a=n.user||(null===(e=n.data)||void 0===e?void 0:e.user)||n;i(a||{})}catch(n){console.error("Failed to fetch user details for Call Settings",n),i({})}})()},[y]),(0,a.useEffect)(()=>{(async()=>{if(null!==e&&void 0!==e&&e.businessId){u(!0);try{const i=await(0,d.H2)("/branch/".concat(e.businessId,"/branches"),"GET"),n=i.data||i.branches||i,a=(Array.isArray(n)?n:n.data||[]).map(e=>{var i,n,a,l,d;const o=(null===(i=e.user)||void 0===i?void 0:i.name)||e.branchName||(null===(n=e.manager)||void 0===n?void 0:n.name)||"Unknown",s=(null===(a=e.user)||void 0===a?void 0:a.phone)||e.phone||e.didNumber||"",t=Array.isArray(e.didNumbers)&&e.didNumbers[0]||e.didNumber||e.did||(null===(l=e.user)||void 0===l?void 0:l.didNumber)||"",r="boolean"===typeof e.callforward?e.callforward:!!e.stickyBranch,c="boolean"===typeof e.clickToCall?e.clickToCall:!!(e.mobile||null!==(d=e.user)&&void 0!==d&&d.mobile||e.callToMobile);return{id:e._id||e.id,name:o,phone:s,did:t,raw:e,stickyBranch:r,clickToCall:c}});o(a);const l={};a.forEach(e=>l[e.id]=e.phone||""),m(l)}catch(i){console.error("Failed to fetch agents for Call Settings",i),o([])}finally{u(!1)}}})()},[null===e||void 0===e?void 0:e.businessId]),(0,a.useEffect)(()=>{if(!n||0===n.length)return;let e=!1;const i=[];if(n.forEach(e=>{const n=e.did;n&&void 0===g[n]&&i.push(n)}),0===i.length)return;return(async()=>{for(const v of i){if(e)break;try{var n,a,l,o,s,t,r,c;const e=await(0,d.H2)("/api/v1/numbers/business/by-number/".concat(encodeURIComponent(v)),"GET"),i=null!==(n=null!==(a=null!==(l=null!==(o=null===e||void 0===e||null===(s=e.data)||void 0===s?void 0:s.extension)&&void 0!==o?o:null===e||void 0===e||null===(t=e.data)||void 0===t?void 0:t.sip_endpoint)&&void 0!==l?l:null===e||void 0===e||null===(r=e.data)||void 0===r?void 0:r.extensionNumber)&&void 0!==a?a:null===e||void 0===e||null===(c=e.data)||void 0===c?void 0:c.ext)&&void 0!==n?n:null;N(e=>({...e,[v]:null!==i&&void 0!==i?i:"\u2014"}))}catch(u){N(e=>({...e,[v]:"\u2014"}))}}})(),()=>{e=!0}},[n,g]);return(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"d-flex justify-content-between align-items-center mb-4",children:(0,r.jsx)("h1",{className:"h3",children:"Call Settings"})}),(0,r.jsx)(l.E$,{className:"mb-4",children:(0,r.jsxs)(l.W6,{children:[(0,r.jsx)("h5",{children:"Call Forward"}),(0,r.jsx)("p",{className:"text-muted",children:"Configure per-agent call forward phone numbers below."}),c?(0,r.jsx)("div",{className:"text-center py-4",children:(0,r.jsx)(l.JT,{})}):0===n.length?(0,r.jsx)("div",{className:"text-muted",children:"No agents found for your business."}):(0,r.jsxs)("div",{children:[(0,r.jsxs)(l.sK,{className:"align-items-center mb-2 g-1",children:[(0,r.jsx)(l.UF,{sm:3,className:"fw-semibold",children:"Agent"}),(0,r.jsx)(l.UF,{sm:3,className:"fw-semibold text-muted",children:"Assigned DID"}),(0,r.jsx)(l.UF,{sm:2,className:"fw-semibold",children:"Extension"}),(0,r.jsx)(l.UF,{sm:2,className:"fw-semibold",children:"Agent Number"}),(0,r.jsx)(l.UF,{sm:1,className:"fw-semibold text-end",children:"Save"}),(0,r.jsx)(l.UF,{sm:1,className:"fw-semibold text-center",children:"Forward"})]}),n.map(e=>(0,r.jsxs)(l.sK,{className:"align-items-center mb-3 g-1",children:[(0,r.jsx)(l.UF,{sm:3,className:"fw-semibold",children:e.name}),(0,r.jsx)(l.UF,{sm:3,className:"text-muted",children:(0,r.jsx)("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:e.did?e.did:"\u2014"})}),(0,r.jsx)(l.UF,{sm:2,className:"text-muted",children:(0,r.jsx)("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:((i,n,a,l)=>{const d=e.did;return d&&void 0!==g[d]?g[d]:null!==(i=null!==(n=null===(a=e.raw)||void 0===a?void 0:a.extension)&&void 0!==n?n:null===(l=e.raw)||void 0===l?void 0:l.extensionNumber)&&void 0!==i?i:"\u2014"})()})}),(0,r.jsx)(l.UF,{sm:2,children:(0,r.jsx)(l.OG,{type:"text",value:v[e.id]||"",onChange:i=>{return n=e.id,a=i.target.value,void m(e=>({...e,[n]:a}));var n,a},placeholder:"Enter phone number"})}),(0,r.jsx)(l.UF,{sm:1,className:"text-end",children:(0,r.jsx)(l.Q_,{color:"primary",onClick:()=>(async e=>{const i=e.id,n=v&&v[i]||"";f(e=>[...e,i]),x(e=>[...e,i]);try{var a,l,o,t,r,c;const v={userPhone:n};await(0,d.H2)("/branch/edit/".concat(i),"PATCH",v);const h=e.did||(null===(a=e.raw)||void 0===a?void 0:a.didNumber)||(null===(l=e.raw)||void 0===l?void 0:l.did),f=h?g[h]:void 0,b=f&&"\u2014"!==f?f:(null===(o=e.raw)||void 0===o?void 0:o.extension)||(null===(t=e.raw)||void 0===t?void 0:t.extensionNumber)||(null===(r=e.raw)||void 0===r?void 0:r.didNumber)||(null===(c=e.raw)||void 0===c?void 0:c.did)||null;try{b&&(n&&""!==String(n).trim()?await(0,d.H2)("/api/agent/".concat(encodeURIComponent(b),"/mobile"),"POST",{mobile:String(n)}):await(0,d.H2)("/api/agent/".concat(encodeURIComponent(b),"/mobile"),"DELETE",null,{data:{}})),s().fire({icon:"success",title:"Saved",text:"Phone for ".concat(e.name," updated.")})}catch(w){var u,m;console.error("Failed to update agent mobile in AST DB",w),s().fire({icon:"warning",title:"Partial save",text:"Phone saved for ".concat(e.name,", but AST DB update failed: ").concat((null===w||void 0===w||null===(u=w.response)||void 0===u||null===(m=u.data)||void 0===m?void 0:m.message)||(null===w||void 0===w?void 0:w.message))})}}catch(w){var h,b;console.error("Failed to save phone for agent",i,w),s().fire({icon:"error",title:"Error",text:(null===w||void 0===w||null===(h=w.response)||void 0===h||null===(b=h.data)||void 0===b?void 0:b.message)||"Failed to save phone"})}finally{f(e=>e.filter(e=>e!==i)),x(e=>e.filter(e=>e!==i))}})(e),disabled:h.includes(e.id)||b.includes(e.id),size:"sm",children:h.includes(e.id)||b.includes(e.id)?"Saving...":"Save"})}),(0,r.jsx)(l.UF,{sm:1,className:"text-center",children:(0,r.jsx)(l.Qb,{id:"cf_switch_".concat(e.id),checked:!!e.stickyBranch,onChange:()=>(async e=>{var i,n,a,l,t,r;const c=e.id,u=!e.stickyBranch,m=e.did||(null===(i=e.raw)||void 0===i?void 0:i.didNumber)||(null===(n=e.raw)||void 0===n?void 0:n.did),h=m?g[m]:void 0,f=h&&"\u2014"!==h?h:(null===(a=e.raw)||void 0===a?void 0:a.extension)||(null===(l=e.raw)||void 0===l?void 0:l.extensionNumber)||(null===(t=e.raw)||void 0===t?void 0:t.didNumber)||(null===(r=e.raw)||void 0===r?void 0:r.did)||null,b=v&&v[c]||e.phone||"";o(e=>e.map(e=>e.id===c?{...e,stickyBranch:u}:e)),p(e=>[...e,c]);try{if(!f)throw new Error("No extension available for this agent to configure call forward.");u?await(0,d.H2)("/v1/sipdatabase/astdb/cf","POST",{extension:String(f),user_phone:String(b)}):await(0,d.H2)("/v1/sipdatabase/astdb/cf","DELETE",null,{data:{extension:String(f)}}),await(0,d.H2)("/branch/edit/".concat(c),"PATCH",{stickyBranch:u,callforward:u})}catch(N){var x,w;o(e=>e.map(e=>e.id===c?{...e,stickyBranch:!u}:e)),console.error("Failed to toggle forward for agent",c,N),s().fire({icon:"error",title:"Error",text:(null===N||void 0===N||null===(x=N.response)||void 0===x||null===(w=x.data)||void 0===w?void 0:w.message)||(null===N||void 0===N?void 0:N.message)||"Failed to update forward flag"})}finally{p(e=>e.filter(e=>e!==c))}})(e),disabled:w.includes(e.id),label:""})})]},e.id))]})]})})]})}}}]);