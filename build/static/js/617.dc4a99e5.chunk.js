"use strict";(self.webpackChunk_coreui_coreui_free_react_admin_template=self.webpackChunk_coreui_coreui_free_react_admin_template||[]).push([[617],{60617:function(e,s,t){t.r(s),t.d(s,{default:function(){return o}});var a=t(9950),l=t(49911),i=t(2720);t(70428);const n={open:"Open",in_progress:"In Progress",resolved:"Resolved",closed:"Closed"};var r=t(44414);var o=()=>{var e;const[s,t]=(0,a.useState)(null),[o,d]=(0,a.useState)(null),[c,u]=(0,a.useState)(null),[v,h]=(0,a.useState)(!1),[x,m]=(0,a.useState)(null),[g,p]=(0,a.useState)(""),[j,b]=(0,a.useState)("");(0,a.useEffect)(()=>{(async()=>{try{var e,s,a,l;if(!localStorage.getItem("authToken"))throw new Error("Authentication token not found");console.log("Fetching user details...");const m=await(0,i.H2)(i.Hr.USER_DETAILS);console.log("User details response:",m);const g=null!==(e=null!==(s=null!==(a=null===m||void 0===m?void 0:m.user)&&void 0!==a?a:null===m||void 0===m||null===(l=m.data)||void 0===l?void 0:l.user)&&void 0!==s?s:null===m||void 0===m?void 0:m.data)&&void 0!==e?e:null;if(g){var n,r,o,c,v,h,x;u(g);const e=null!==(n=null!==(r=null!==(o=g.businessId)&&void 0!==o?o:null===(c=g.business)||void 0===c?void 0:c._id)&&void 0!==r?r:null===(v=g.business)||void 0===v?void 0:v.id)&&void 0!==n?n:null;e?(console.log("Setting business ID:",e),t(e)):console.warn("Business ID not found in user object",g);const s=null!==(h=null!==(x=g._id)&&void 0!==x?x:g.id)&&void 0!==h?h:null;s&&(console.log("Setting user ID:",s),d(s))}else console.error("User object not found in response:",m)}catch(A){console.error("Error fetching user details:",A),m("Failed to load user details. Please refresh the page.")}})()},[]);const[y,f]=(0,a.useState)("High"),[S,N]=(0,a.useState)("Technical"),[C,w]=(0,a.useState)(!1),[k,I]=(0,a.useState)([]),[T,_]=(0,a.useState)(!0),[A,E]=(0,a.useState)(null),[D,P]=(0,a.useState)(1),[M,H]=(0,a.useState)(""),[L,U]=(0,a.useState)("all"),[B,F]=(0,a.useState)(null),[O,Q]=(0,a.useState)([]),[R,q]=(0,a.useState)(""),[$,z]=(0,a.useState)(!1),[G,J]=(0,a.useState)("in_progress"),K=async()=>{try{_(!0),E(null);const e=(await(0,i.H2)(i.Hr.TICKETS)).tickets.map(e=>{const s=(e.status||"").toString(),t=s.trim().toLowerCase().replace(/\s+/g,"_").replace(/-/g,"_"),a=n[t]||n[s]||"Open";return{id:e._id,subject:e.subject,description:e.description,priority:e.priority,category:e.category,status:a,createdBy:e.createdBy,businessId:e.businessId,createdAt:e.createdAt,resolvedAt:e.resolvedAt,assignedTo:e.assignedTo,lastMessage:e.lastMessage,updatedAt:e.updatedAt}});I(e)}catch(t){var e,s;E((null===t||void 0===t||null===(e=t.response)||void 0===e||null===(s=e.data)||void 0===s?void 0:s.message)||"Failed to fetch tickets.")}finally{_(!1)}};(0,a.useEffect)(()=>{P(1)},[M,L]),(0,a.useEffect)(()=>{K()},[]);const Y=async e=>{try{const s=await(0,i.H2)(i.Hr.TICKET_MESSAGES(e));null!==s&&void 0!==s&&s.success&&Q(s.messages)}catch(s){console.error("Failed to fetch ticket messages:",s)}},V=e=>(0,r.jsx)(l.$X,{color:{low:"info",medium:"warning",high:"danger"}[null===e||void 0===e?void 0:e.toLowerCase()]||"secondary",children:(null===e||void 0===e?void 0:e.toUpperCase())||"N/A"}),X=Math.max(1,Math.ceil(k.length/10)),W=k.slice(10*(D-1),10*D);return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{className:"max-w-full overflow-x-auto p-4",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-gray-800 dark:text-white",children:"Ticketing System"}),(0,r.jsx)(l.Q_,{color:"primary",onClick:()=>h(!0),children:"Create Ticket"})]}),A&&(0,r.jsx)(l.kj,{color:"danger",dismissible:!0,children:A}),(0,r.jsxs)(l.zS,{visible:v,onClose:()=>h(!1),children:[(0,r.jsx)(l.E4,{closeButton:!0,children:(0,r.jsx)(l.lb,{children:"Create New Ticket"})}),(0,r.jsxs)(l.qI,{onSubmit:async e=>{e.preventDefault(),console.log("Create ticket function called");try{w(!0),m(null),console.log("Form Data:",{subject:g,description:j,priority:y,category:S});const e=localStorage.getItem("authToken");if(console.log("Auth Token exists:",!!e),console.log("User Details State:",{userDetails:c,businessId:s,userId:o}),!g||!j)throw new Error("Subject and description are required");if(!s)throw console.error("Business ID missing during ticket creation. Current state:",{userDetails:c,businessId:s,userId:o}),new Error("Business information not available");if(!o)throw console.error("User ID missing during ticket creation. Current state:",{userDetails:c,businessId:s,userId:o}),new Error("User information not available");const r={subject:g,description:j,priority:y,category:S,businessId:s,createdBy:o};console.log("Creating ticket with data:",r);try{console.log("Making API request to:","".concat((0,i.vo)(),"/api/tickets")),console.log("Request headers:",(0,i.dJ)());const e=await(0,i.H2)(i.Hr.TICKETS,"POST",r);console.log("Ticket creation response:",e),e&&(p(""),b(""),f("High"),N("Technical"),h(!1),await K())}catch(D){var t,a,l,n;throw console.error("API Error:",{status:null===(t=D.response)||void 0===t?void 0:t.status,statusText:null===(a=D.response)||void 0===a?void 0:a.statusText,data:null===(l=D.response)||void 0===l?void 0:l.data,headers:null===(n=D.response)||void 0===n?void 0:n.headers}),D}}catch(P){var r,d,u,v,x,C,k,I,T,_;if(console.error("Error Details:",{message:P.message,response:null===(r=P.response)||void 0===r?void 0:r.data,status:null===(d=P.response)||void 0===d?void 0:d.status,statusText:null===(u=P.response)||void 0===u?void 0:u.statusText,config:{url:null===(v=P.config)||void 0===v?void 0:v.url,method:null===(x=P.config)||void 0===x?void 0:x.method,headers:null===(C=P.config)||void 0===C?void 0:C.headers,data:null===(k=P.config)||void 0===k?void 0:k.data}}),c)if(null!==(I=c.business)&&void 0!==I&&I._id)if(401===(null===(T=P.response)||void 0===T?void 0:T.status))m("Authentication failed. Please log in again.");else if(400===(null===(_=P.response)||void 0===_?void 0:_.status))m(P.response.data.message||"Invalid ticket data.");else{var A,E;m((null===(A=P.response)||void 0===A||null===(E=A.data)||void 0===E?void 0:E.message)||"Failed to create ticket. Please try again.")}else m("Business information not available. Please refresh the page.");else m("User details not loaded. Please refresh the page.")}finally{w(!1),console.log("Create ticket operation completed")}},children:[(0,r.jsxs)(l.Tc,{children:[x&&(0,r.jsx)(l.kj,{color:"danger",children:x}),(0,r.jsx)("div",{className:"mb-3",children:(0,r.jsx)(l.OG,{type:"text",id:"subject",label:"Subject",value:g,onChange:e=>p(e.target.value),required:!0})}),(0,r.jsx)("div",{className:"mb-3",children:(0,r.jsx)(l.Im,{id:"description",label:"Description",rows:4,value:j,onChange:e=>b(e.target.value),required:!0})}),(0,r.jsx)("div",{className:"mb-3",children:(0,r.jsx)(l.MT,{id:"priority",label:"Priority",value:y,onChange:e=>f(e.target.value),options:[{label:"High",value:"High"},{label:"Medium",value:"Medium"},{label:"Low",value:"Low"}]})}),(0,r.jsx)("div",{className:"mb-3",children:(0,r.jsx)(l.MT,{id:"category",label:"Category",value:S,onChange:e=>N(e.target.value),options:[{label:"Technical",value:"Technical"},{label:"Billing",value:"Billing"},{label:"Feature Request",value:"Feature Request"},{label:"Other",value:"Other"}]})})]}),(0,r.jsxs)(l.If,{children:[(0,r.jsx)(l.Q_,{color:"secondary",onClick:()=>h(!1),children:"Cancel"}),(0,r.jsx)(l.Q_,{color:"primary",type:"submit",disabled:C,children:C?(0,r.jsx)(l.JT,{size:"sm"}):"Create Ticket"})]})]})]}),(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-sm p-4 mb-4",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsxs)(l.BG,{children:[(0,r.jsx)(l.sk,{children:(0,r.jsx)("i",{className:"fas fa-search text-gray-400"})}),(0,r.jsx)(l.OG,{type:"text",id:"searchQuery",placeholder:"Search tickets...",value:M,onChange:e=>H(e.target.value)})]})}),(0,r.jsx)("div",{style:{width:"180px"},children:(0,r.jsx)(l.MT,{id:"filterStatus",value:L,onChange:e=>U(e.target.value),options:[{label:"All Tickets",value:"all"},{label:"Open",value:"Open"},{label:"In Progress",value:"In Progress"},{label:"Resolved",value:"Resolved"},{label:"Closed",value:"Closed"}]})}),(M||"all"!==L)&&(0,r.jsx)(l.Q_,{color:"secondary",variant:"outline",size:"sm",onClick:()=>{H(""),U("all")},children:"Clear"})]})}),(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:(0,r.jsxs)(l._v,{hover:!0,responsive:!0,striped:!0,children:[(0,r.jsx)(l.wV,{children:(0,r.jsxs)(l.YI,{className:"bg-light",children:[(0,r.jsx)(l.$s,{className:"px-4 py-3 text-xs font-semibold text-gray-600",children:"#"}),(0,r.jsx)(l.$s,{className:"px-4 py-3 text-xs font-semibold text-gray-600",children:"Subject"}),(0,r.jsx)(l.$s,{className:"px-4 py-3 text-xs font-semibold text-gray-600",children:"Priority"}),(0,r.jsx)(l.$s,{className:"px-4 py-3 text-xs font-semibold text-gray-600",children:"Category"}),(0,r.jsx)(l.$s,{className:"px-4 py-3 text-xs font-semibold text-gray-600",children:"Created"}),(0,r.jsx)(l.$s,{className:"px-4 py-3 text-xs font-semibold text-gray-600",children:"Resolved"}),(0,r.jsx)(l.$s,{className:"px-4 py-3 text-xs font-semibold text-gray-600",children:"Messages"})]})}),(0,r.jsx)(l.jS,{children:T?(0,r.jsx)(l.YI,{children:(0,r.jsx)("td",{colSpan:7,className:"text-center py-8",children:(0,r.jsx)(l.JT,{className:"mx-auto"})})}):0===k.filter(e=>{if("all"!==L&&String(e.status||"")!==String(L||""))return!1;if(M){const s=M.toLowerCase();return String(e.subject||"").toLowerCase().includes(s)||String(e.description||"").toLowerCase().includes(s)||String(e.category||"").toLowerCase().includes(s)||String(e.status||"").toLowerCase().includes(s)}return!0}).length?(0,r.jsx)(l.YI,{children:(0,r.jsx)("td",{colSpan:7,className:"text-center py-8 text-gray-500",children:"No tickets logged."})}):W.map((e,s)=>(0,r.jsxs)(l.YI,{className:"hover:bg-gray-50",children:[(0,r.jsx)(l.cC,{className:"px-4 py-3",children:10*(D-1)+s+1}),(0,r.jsx)(l.cC,{className:"px-4 py-3 font-medium",children:e.subject}),(0,r.jsx)(l.cC,{className:"px-4 py-3",children:V(e.priority)}),(0,r.jsx)(l.cC,{className:"px-4 py-3",children:e.category||"N/A"}),(0,r.jsx)(l.cC,{className:"px-4 py-3 text-xs text-gray-500",children:new Date(e.createdAt).toLocaleString()}),(0,r.jsx)(l.cC,{className:"px-4 py-3 text-xs text-gray-500",children:e.resolvedAt?new Date(e.resolvedAt).toLocaleString():"-"}),(0,r.jsx)(l.cC,{className:"px-4 py-3 text-center",children:(0,r.jsx)(l.Q_,{color:"info",variant:"ghost",size:"sm",className:"min-w-[100px]",onClick:()=>{F(e),Y(e.id)},children:"View Messages"})})]},e.id))})]})}),(0,r.jsxs)("div",{className:"flex justify-end mt-4 gap-2",children:[(0,r.jsx)(l.Q_,{onClick:()=>P(e=>Math.max(e-1,1)),disabled:1===D,variant:"outline",children:"Prev"}),(0,r.jsx)("span",{className:"py-2 px-3",children:"Page ".concat(D," of ").concat(X)}),(0,r.jsx)(l.Q_,{onClick:()=>P(e=>Math.min(e+1,X)),disabled:D===X,variant:"outline",children:"Next"})]}),B&&(0,r.jsxs)(l.zS,{visible:!0,onClose:()=>{F(null),Q([])},size:"md",className:"modern-chat-modal",children:[(0,r.jsx)(l.E4,{className:"chat-header",children:(0,r.jsxs)(l.lb,{className:"chat-modal-title",children:[(0,r.jsx)("div",{className:"ticket-subject",children:null===B||void 0===B?void 0:B.subject}),(0,r.jsxs)("div",{className:"ticket-id",children:["Ticket #",(null===B||void 0===B?void 0:B.ticketNo)||(null===B||void 0===B||null===(e=B.id)||void 0===e?void 0:e.slice(-6))]})]})}),(0,r.jsx)(l.Tc,{className:"p-0",children:(0,r.jsx)("div",{className:"chat-body",children:0===O.length?(0,r.jsx)("div",{className:"flex items-center justify-center h-full text-center",children:(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-4xl text-gray-300 mb-3",children:"\ud83d\udcac"}),(0,r.jsx)("p",{className:"text-gray-500 text-sm",children:"No messages yet. Start the conversation!"})]})}):(0,r.jsx)("div",{className:"messages-container",children:O.map(e=>{var t,a,l,i,n;const d=s||(null===c||void 0===c?void 0:c.businessId)||(null===c||void 0===c||null===(t=c.business)||void 0===t?void 0:t._id),u=o||(null===c||void 0===c?void 0:c._id),v=(null===(a=e.sender)||void 0===a?void 0:a.businessId)||(null===(l=e.sender)||void 0===l||null===(i=l.business)||void 0===i?void 0:i._id)||null,h=(null===c||void 0===c?void 0:c.email)||"",x=h.includes("@")?h.split("@")[1]:"",m=(null===(n=e.sender)||void 0===n?void 0:n.email)||"",g=m.includes("@")?m.split("@")[1]:"",p=v&&d&&String(v)===String(d)||e.sender&&u&&String(e.sender._id)===String(u)||x&&g&&x===g;return(0,r.jsx)("div",{className:"chat-message ".concat(p?"sent":"received"),children:(0,r.jsxs)("div",{className:"flex items-start ".concat(p?"flex-row-reverse":"flex-row"),children:[(0,r.jsx)("div",{className:"chat-avatar ".concat(p?"sent":"received"),children:e.sender.name?e.sender.name.charAt(0).toUpperCase():"?"}),(0,r.jsxs)("div",{className:"chat-message-content",children:[(0,r.jsx)("span",{className:"chat-sender-name",children:e.sender.name}),(0,r.jsxs)("div",{className:"chat-message-bubble ".concat(p?"sent":"received"),children:[(0,r.jsx)("p",{children:e.message}),e.statusUpdate&&(0,r.jsx)("div",{className:"status-update",children:"resolved"===e.statusUpdate?(0,r.jsx)("span",{children:"\u2713 Resolved"}):(0,r.jsx)("span",{children:"\u21bb In Progress"})})]}),(0,r.jsx)("div",{className:"chat-time",children:new Date(e.createdAt).toLocaleString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})})]})]})},e._id)})})})}),(0,r.jsx)(l.If,{className:"chat-footer p-2",children:(0,r.jsxs)(l.BG,{children:[(0,r.jsx)(l.Im,{value:R,onChange:e=>q(e.target.value),placeholder:"Type a message...",rows:1,className:"chat-input"}),(0,r.jsx)(l.Q_,{color:"primary",className:"chat-send-button",onClick:()=>B&&(async(e,s)=>{try{z(!0),await(0,i.H2)(i.Hr.TICKET_MESSAGES(e),"POST",{message:s,statusUpdate:G}),I(s=>s.map(s=>s.id===e?{...s,status:n[G]}:s)),await Y(e),q("")}catch(l){var t,a;E((null===l||void 0===l||null===(t=l.response)||void 0===t||null===(a=t.data)||void 0===a?void 0:a.message)||"Failed to send message")}finally{z(!1)}})(B.id||B._id,R),disabled:!R.trim()||$,children:$?(0,r.jsx)(l.JT,{size:"sm",component:"span","aria-hidden":"true",className:"text-white"}):"Send"})]})})]})]})})}}}]);