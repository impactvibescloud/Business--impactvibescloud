"use strict";(self.webpackChunk_coreui_coreui_free_react_admin_template=self.webpackChunk_coreui_coreui_free_react_admin_template||[]).push([[3944],{93944:function(e,t,n){n.r(t);var a=n(9950),i=n(49911),s=n(4695),l=n.n(s),r=n(26910),c=n(2720),o=n(44414);t.default=()=>{const[e,t]=(0,a.useState)(""),[n,s]=(0,a.useState)([]),[d,u]=(0,a.useState)(!1),[h,m]=(0,a.useState)(!1),[x,p]=(0,a.useState)(""),[v,j]=(0,a.useState)(""),[f,y]=(0,a.useState)(null),[g,N]=(0,a.useState)(""),[w,b]=(0,a.useState)(""),[C,I]=(0,a.useState)(""),[S,A]=(0,a.useState)([]),[R,k]=(0,a.useState)({name:"",menu:{welcome:"",options:[],repeat:""},children:[]}),[_,O]=(0,a.useState)([]),[T,V]=(0,a.useState)(!1),L=(0,a.useRef)(null),D=(0,a.useRef)(null),[z,U]=(0,a.useState)(null),[B,E]=(0,a.useState)(null),M=localStorage.getItem("authToken"),[G,Q]=(0,a.useState)(!1),[F,J]=(0,a.useState)(null),[P,$]=(0,a.useState)(!1),W=(e,t)=>{if(!t||0===t.length)return e;const[n,...a]=t;return e.children&&e.children[n]?W(e.children[n],a):{name:"",menu:{welcome:"",options:[],repeat:""},children:[]}},H=(e,t,n)=>{if(!t||0===t.length)return n;const[a,...i]=t,s=(e.children||[]).map((e,t)=>t===a?H(e,i,n):e);return{...e,children:s}},K=(e,t)=>{k(n=>H(n,e,t))},Y=(e,t,n)=>{k(a=>{var i;const s=W(a,e),l=((null===(i=s.menu)||void 0===i?void 0:i.options)||[]).map((e,a)=>a===t?n:e),r={...s,menu:{...s.menu,options:l}};return H(a,e,r)})},q=e=>{var t,n,a;let{path:s}=e;const l=W(R,s);return(0,o.jsxs)("div",{className:"border rounded p-2 mb-2",children:[(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)(i.A6,{children:"Node Key"}),(0,o.jsx)(i.OG,{value:l.name||"",onChange:e=>K(s,{...l,name:e.target.value}),placeholder:"e.g. menu or SalesMenu"})]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)(i.A6,{children:"Welcome Message"}),(0,o.jsx)(i.OG,{value:(null===(t=l.menu)||void 0===t?void 0:t.welcome)||"",onChange:e=>K(s,{...l,menu:{...l.menu,welcome:e.target.value}})})]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)(i.A6,{children:"Options"}),((null===(n=l.menu)||void 0===n?void 0:n.options)||[]).map((e,t)=>(0,o.jsxs)("div",{className:"input-group mb-2",children:[(0,o.jsx)(i.OG,{style:{maxWidth:80},value:e.key||"",placeholder:"Key",onChange:n=>Y(s,t,{...e,key:n.target.value})}),(0,o.jsx)(i.OG,{value:e.text||"",placeholder:"Option text",onChange:n=>Y(s,t,{...e,text:n.target.value})}),(0,o.jsxs)("select",{className:"form-control",style:{maxWidth:180,marginRight:6},value:e.destinationType||"menu",onChange:n=>Y(s,t,{...e,destinationType:n.target.value,destination:""}),children:[(0,o.jsx)("option",{value:"menu",children:"Menu (text)"}),(0,o.jsx)("option",{value:"did",children:"DID Number"})]}),"did"===(e.destinationType||"menu")?(0,o.jsxs)("select",{className:"form-control",style:{maxWidth:220},value:e.destination||"",onChange:n=>Y(s,t,{...e,destination:n.target.value}),children:[(0,o.jsx)("option",{value:"",children:"Select DID"}),T?(0,o.jsx)("option",{disabled:!0,children:"Loading..."}):_.map(e=>(0,o.jsx)("option",{value:e.id,children:e.number},e.id))]}):(0,o.jsx)(i.OG,{value:e.destination||"",placeholder:"Destination (menu name)",onChange:n=>Y(s,t,{...e,destination:n.target.value})}),(0,o.jsx)("button",{type:"button",className:"btn btn-danger",onClick:()=>((e,t)=>{k(n=>{var a;const i=W(n,e),s=((null===(a=i.menu)||void 0===a?void 0:a.options)||[]).filter((e,n)=>n!==t),l={...i,menu:{...i.menu,options:s}};return H(n,e,l)})})(s,t),children:"Remove"})]},t)),(0,o.jsx)("div",{className:"mt-2",children:(0,o.jsx)(i.Q_,{color:"secondary",size:"sm",onClick:()=>(e=>{k(t=>{var n;const a=W(t,e),i=[...(null===(n=a.menu)||void 0===n?void 0:n.options)||[],{key:"",text:"",destination:"",destinationType:"menu"}],s={...a,menu:{...a.menu,options:i}};return H(t,e,s)})})(s),children:"Add Option"})})]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)(i.A6,{children:"Repeat Message"}),(0,o.jsx)(i.OG,{value:(null===(a=l.menu)||void 0===a?void 0:a.repeat)||"",onChange:e=>K(s,{...l,menu:{...l.menu,repeat:e.target.value}})})]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)(i.a5,{className:"text-muted",children:"Children menus"}),(l.children||[]).map((e,t)=>(0,o.jsxs)("div",{className:"ms-3",children:[(0,o.jsx)(q,{path:[...s,t]}),(0,o.jsx)("div",{className:"mb-2 text-end",children:(0,o.jsx)("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>((e,t)=>{k(n=>{const a=W(n,e),i=(a.children||[]).filter((e,n)=>n!==t),s={...a,children:i};return H(n,e,s)})})(s,t),children:"Remove Child"})})]},t)),(0,o.jsx)("div",{children:(0,o.jsx)(i.Q_,{color:"secondary",size:"sm",onClick:()=>(e=>{k(t=>{const n=W(t,e),a={...n,children:[...n.children||[],{name:"",menu:{welcome:"",options:[],repeat:""},children:[]}]};return H(t,e,a)})})(s),children:"Add Child Menu"})})]})]})};(0,a.useEffect)(()=>{(async()=>{try{const e=await(0,c.H2)("/v1/user/details","GET"),n=e.user||e.data||e;n&&n.businessId&&t(n.businessId)}catch(e){console.warn("Failed to fetch user details",e)}})()},[]),(0,a.useEffect)(()=>{e&&X()},[e]),(0,a.useEffect)(()=>{if(!e)return;(async()=>{V(!0);try{const t=await(0,c.H2)("/numbers/assigned-to/".concat(e),"GET"),n=t.data||t.numbers||t||[],a=(Array.isArray(n)?n:[]).map(e=>({id:e._id||e.id,number:e.number||e}));O(a)}catch(t){console.warn("Failed to fetch DIDs",t)}finally{V(!1)}})()},[e]),(0,a.useEffect)(()=>()=>{if(z)try{window.URL.revokeObjectURL(z)}catch(e){}},[z]);const X=async()=>{u(!0);try{const t="".concat((0,c.vo)(),"/api/ivr/tree/menu?businessId=").concat(e),n=await r.A.get(t,{headers:{Authorization:"Bearer ".concat(M)}}),a=n&&n.data?n.data:n,i=a&&(a.tree||a);s(i?Array.isArray(i)?i:[i]:[])}catch(t){console.error("Failed to fetch IVRs",t),s([])}finally{u(!1)}},Z=e=>{let{node:t,level:n=0}=e;if(!t)return null;const a={marginLeft:"".concat(12*n,"px"),borderLeft:0===n?"none":"1px dashed #ccc",paddingLeft:"8px"},i=t.menu||{},s=t.children||[];return(0,o.jsxs)("div",{style:a,className:"mb-2",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:t.name||t.fileName||"Menu"})," ",t.fileName?(0,o.jsxs)("span",{className:"text-muted",children:["(",t.fileName,")"]}):null]}),i.welcome?(0,o.jsx)("div",{className:"text-muted",children:i.welcome}):null,i.options&&i.options.length>0&&(0,o.jsxs)("div",{className:"mt-1",children:[(0,o.jsx)("small",{className:"text-muted",children:"Options:"}),(0,o.jsx)("ul",{children:i.options.map((e,t)=>(0,o.jsxs)("li",{children:[e.key,": ",e.text," \u2192 ",e.destination]},e._id||t))})]}),i.repeat?(0,o.jsxs)("div",{className:"text-muted",children:["Repeat: ",i.repeat]}):null,s&&s.length>0&&(0,o.jsxs)("div",{className:"mt-2",children:[(0,o.jsx)("small",{className:"text-muted",children:"Children:"}),(0,o.jsx)("div",{children:s.map((e,t)=>e&&e.child?(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsxs)("div",{className:"text-muted",children:["On press ",(0,o.jsx)("strong",{children:e.key})," \u2192 ",e.destination]}),(0,o.jsx)(Z,{node:e.child,level:n+1})]},t):(0,o.jsx)(Z,{node:e,level:n+1},t))})]})]})},ee=()=>{try{if(D.current&&(D.current.pause(),D.current.currentTime=0,D.current.src=""),z)try{window.URL.revokeObjectURL(z)}catch(e){}}finally{U(null),E(null)}},te=n.filter(e=>{const t=(e.name||"").toString().toLowerCase();return"menu"===t||"main"===t||"root"===t||(!!(e.menu&&Array.isArray(e.children)&&e.children.length>0)||(!!(Array.isArray(e.children)&&e.children.length>0)||!!e.uploadedToAsterisk))}),[ne,ae]=(0,a.useState)([]),ie=e=>ne.includes(e),se=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(!t)return[];const s=t._id||t.name||a||Math.random().toString(36).slice(2),d={paddingLeft:"".concat(18*n,"px")},u=[];return u.push((0,o.jsxs)(i.YI,{children:[(0,o.jsx)(i.cC,{children:(0,o.jsxs)("div",{style:d,className:"d-flex align-items-center",children:[t.children&&t.children.length>0?(0,o.jsx)(i.Q_,{color:"light",size:"sm",className:"me-2",onClick:()=>{return e=s,void ae(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e]);var e},children:ie(s)?"\u25be":"\u25b8"}):(0,o.jsx)("span",{style:{width:34}}),(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{children:(0,o.jsx)("strong",{children:t.name||t.fileName||"Menu"})}),t.menu&&t.menu.welcome?(0,o.jsx)("div",{className:"text-muted small",children:t.menu.welcome}):null]})]})}),(0,o.jsx)(i.cC,{children:t.description||"-"}),(0,o.jsx)(i.cC,{children:t.name||t.fileName?(0,o.jsx)(i.Q_,{color:"link",size:"sm",className:"p-0",onClick:()=>(async e=>{const t=e.name||e.fileName||e.file||"";if(!t)return l().fire({icon:"error",title:"No audio",text:"No audio file available for this IVR."});try{const e="".concat((0,c.vo)(),"/api/ivr/download/").concat(encodeURIComponent(t)),n=await r.A.get(e,{responseType:"arraybuffer",headers:{Authorization:"Bearer ".concat(M)}}),a=n.headers&&n.headers["content-type"]?n.headers["content-type"]:"audio/wav",i=new Blob([n.data],{type:a}),s=window.URL.createObjectURL(i);window.open(s,"_blank"),setTimeout(()=>{try{window.URL.revokeObjectURL(s)}catch(e){}},6e4)}catch(a){var n;console.error("Open failed",a),l().fire({icon:"error",title:"Open failed",text:(null===a||void 0===a||null===(n=a.response)||void 0===n?void 0:n.data)||(null===a||void 0===a?void 0:a.message)||"Could not open audio"})}})(t),children:t.name||t.fileName}):t.audio?(0,o.jsx)("a",{href:t.audio,target:"_blank",rel:"noreferrer",children:"Play"}):"-"}),(0,o.jsx)(i.cC,{style:{maxWidth:300,overflow:"hidden",textOverflow:"ellipsis"},children:t.menu&&t.menu.options&&t.menu.options.map(e=>"".concat(e.key,":").concat(e.text)).join(", ")||t.generatedText||"-"}),(0,o.jsx)(i.cC,{children:t.status||t.state||"-"}),(0,o.jsx)(i.cC,{children:t.createdAt?new Date(t.createdAt).toLocaleString():"-"}),(0,o.jsxs)(i.cC,{children:[(t.name||t.fileName||t.audio)&&(0,o.jsx)(i.Q_,{color:"info",size:"sm",className:"me-2",onClick:()=>(async e=>{const t=e._id||e.id,n=e.name||e.fileName||e.file||"";if(!n)return l().fire({icon:"error",title:"No audio",text:"No audio file available for this IVR."});if(B!==t)try{ee();const e="".concat((0,c.vo)(),"/api/ivr/download/").concat(encodeURIComponent(n)),a=await r.A.get(e,{responseType:"arraybuffer",headers:{Authorization:"Bearer ".concat(M)}}),s=a.headers&&a.headers["content-type"]?a.headers["content-type"]:"audio/wav",l=new Blob([a.data],{type:s}),o=window.URL.createObjectURL(l);if(U(o),E(t),D.current){D.current.src=o;try{D.current.load()}catch(i){}try{await D.current.play()}catch(i){}}}catch(s){var a;console.error("Play failed",s);const e=(null===s||void 0===s||null===(a=s.response)||void 0===a?void 0:a.data)||(null===s||void 0===s?void 0:s.message)||"Could not play audio";l().fire({icon:"error",title:"Play failed",text:e})}else ee()})(t),children:B===(t._id||t.id)?"Stop":"Play"}),(0,o.jsx)(i.Q_,{color:"secondary",size:"sm",className:"me-2",onClick:()=>(async t=>{const n=t.name||t.fileName||t.file||"";if(!n)return l().fire({icon:"error",title:"No tree",text:"No tree available for this IVR."});$(!0);try{const t="".concat((0,c.vo)(),"/api/ivr/tree/").concat(encodeURIComponent(n),"?businessId=").concat(e),a=await r.A.get(t,{headers:{Authorization:"Bearer ".concat(M)}}),i=(a.data&&(a.data.tree||a.data)&&(a.data.tree||a.data.tree||a.data),a.data&&a.data.tree?a.data.tree:a.data&&void 0===a.data.tree?a.data:null);J(i||a.data||null),Q(!0)}catch(s){var a,i;console.error("Fetch tree failed",s),l().fire({icon:"error",title:"Fetch failed",text:(null===s||void 0===s||null===(a=s.response)||void 0===a||null===(i=a.data)||void 0===i?void 0:i.message)||(null===s||void 0===s?void 0:s.message)||"Could not fetch tree"})}finally{$(!1)}})(t),children:"View Tree"}),(0,o.jsx)(i.Q_,{color:"danger",size:"sm",onClick:()=>(async t=>{const n=t._id||t.id;if(!n)return l().fire({icon:"error",title:"Invalid IVR"});if((await l().fire({title:"Delete IVR?",text:'Delete "'.concat(t.name||"IVR",'"?'),icon:"warning",showCancelButton:!0})).isConfirmed)try{const a=(t.name||"").toString().toLowerCase(),i=(t.fileName||"").toString().toLowerCase();if("menu"===a||i.includes("-menu")){const t="".concat((0,c.vo)(),"/api/ivr/nested/menu?businessId=").concat(e);await r.A.delete(t,{headers:{Authorization:"Bearer ".concat(M)}})}else await(0,c.H2)("/api/ivr/".concat(n),"DELETE");l().fire({icon:"success",title:"Deleted"}),await X()}catch(a){console.error("Delete IVR failed",a),l().fire({icon:"error",title:"Delete failed",text:(null===a||void 0===a?void 0:a.message)||"Delete failed"})}})(t),children:"Delete"})]})]},"node-".concat(s))),ie(s)&&t.children&&t.children.length>0&&t.children.forEach((e,t)=>{e&&e.child?(u.push((0,o.jsx)(i.YI,{children:(0,o.jsx)(i.cC,{colSpan:7,children:(0,o.jsxs)("div",{style:{paddingLeft:"".concat(18*(n+1),"px")},className:"text-muted small",children:["On press ",(0,o.jsx)("strong",{children:e.key})," \u2192 ",e.destination]})})},"opt-".concat(s,"-").concat(t))),u.push(...se(e.child,n+1,"".concat(a,"/").concat(t)))):u.push(...se(e,n+1,"".concat(a,"/").concat(t)))}),u};return(0,o.jsx)("div",{className:"p-3",children:(0,o.jsx)(i.E$,{children:(0,o.jsxs)(i.W6,{children:[(0,o.jsxs)(i.sK,{className:"align-items-center mb-3",children:[(0,o.jsxs)(i.UF,{children:[(0,o.jsx)("h3",{children:"IVR Management"}),(0,o.jsx)("p",{className:"text-muted",children:"Create and manage IVR flows and audio prompts."})]}),(0,o.jsx)(i.UF,{className:"text-end",children:(0,o.jsx)(i.Q_,{color:"primary",onClick:()=>m(!0),children:"New IVR"})})]}),(0,o.jsxs)(i.zS,{visible:h,onClose:()=>m(!1),children:[(0,o.jsx)(i.E4,{closeButton:!0,children:(0,o.jsx)(i.lb,{children:"New IVR"})}),(0,o.jsxs)(i.Tc,{children:[(0,o.jsxs)("div",{className:"mb-3",children:[(0,o.jsx)(i.A6,{children:"IVR Name"}),(0,o.jsx)(i.OG,{value:x,onChange:e=>p(e.target.value),placeholder:"IVR name"})]}),(0,o.jsxs)("div",{className:"mb-3",children:[(0,o.jsx)(i.A6,{children:"Description"}),(0,o.jsx)(i.OG,{value:v,onChange:e=>j(e.target.value),placeholder:"Short description"})]}),(0,o.jsxs)("div",{className:"mb-3",children:[(0,o.jsx)(i.A6,{children:"Audio Prompt (optional)"}),(0,o.jsx)(i.OG,{type:"file",accept:"audio/*",onChange:e=>{var t;return y((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)},ref:L}),(0,o.jsx)(i.a5,{className:"text-muted",children:"Upload an audio prompt for this IVR."})]}),(0,o.jsxs)("div",{className:"mb-3",children:[(0,o.jsx)(i.A6,{children:"Menu JSON (optional)"}),(0,o.jsx)("textarea",{className:"form-control",rows:6,value:g,onChange:e=>N(e.target.value),placeholder:"Paste full tree JSON matching the create-nested API (or leave empty to use the visual editor)"}),(0,o.jsx)(i.a5,{className:"text-muted",children:"If provided, this JSON will be sent directly to `/api/ivr/create-nested` as the tree."})]}),(0,o.jsxs)("div",{className:"mb-3",children:[(0,o.jsx)(i.A6,{children:"Build Menu (visual editor)"}),(0,o.jsx)(q,{path:[]}),(0,o.jsx)(i.a5,{className:"text-muted",children:"Use the visual editor to build a nested menu tree. Top-level node name will default to the IVR name if left empty."})]})]}),(0,o.jsxs)(i.If,{children:[(0,o.jsx)(i.Q_,{color:"secondary",onClick:()=>m(!1),children:"Cancel"}),(0,o.jsx)(i.Q_,{color:"primary",onClick:async()=>{if(x&&e)try{if(g&&g.trim().length>0||R&&(R.menu&&(R.menu.welcome||R.menu.options&&R.menu.options.length>0||R.menu.repeat)||R.children&&R.children.length>0)){let t=null;if(g&&g.trim().length>0)try{t=JSON.parse(g)}catch(a){return l().fire({icon:"error",title:"Invalid JSON",text:"Menu JSON is not valid."})}else t={...R},t.name||(t.name=x||"menu");const n="".concat((0,c.vo)(),"/api/ivr/create-nested");await r.A.post(n,{businessId:e,tree:t},{headers:{Authorization:"Bearer ".concat(M),"Content-Type":"application/json"}})}else if(f){const t=new FormData;t.append("name",x),t.append("description",v),t.append("businessId",e),t.append("audio",f);const n="".concat((0,c.vo)(),"/api/ivr");await r.A.post(n,t,{headers:{Authorization:"Bearer ".concat(M),"Content-Type":"multipart/form-data"}})}else{const t="".concat((0,c.vo)(),"/api/ivr");await r.A.post(t,{name:x,description:v,businessId:e},{headers:{Authorization:"Bearer ".concat(M),"Content-Type":"application/json"}})}l().fire({icon:"success",title:"IVR Created"}),m(!1),p(""),j(""),y(null),N(""),b(""),I(""),A([]),k({name:"",menu:{welcome:"",options:[],repeat:""},children:[]}),L.current&&(L.current.value=""),await X()}catch(i){var t,n;console.error("Create IVR failed",i);const e=(null===i||void 0===i||null===(t=i.response)||void 0===t||null===(n=t.data)||void 0===n?void 0:n.message)||i.message||"Create failed";l().fire({icon:"error",title:"Create failed",text:e})}else l().fire({icon:"warning",title:"Missing fields",text:"Please provide a name."})},children:"Create"})]})]}),(0,o.jsxs)("div",{className:"mt-4",children:[(0,o.jsx)("h5",{children:"IVR List"}),d?(0,o.jsx)("div",{className:"py-3 text-center",children:(0,o.jsx)(i.JT,{})}):0===te.length?(0,o.jsx)("p",{className:"text-muted",children:"No IVRs found for this business."}):(0,o.jsx)("div",{className:"table-responsive",children:(0,o.jsxs)(i._v,{children:[(0,o.jsx)(i.wV,{children:(0,o.jsxs)(i.YI,{children:[(0,o.jsx)(i.$s,{children:"Name"}),(0,o.jsx)(i.$s,{children:"Description"}),(0,o.jsx)(i.$s,{children:"File"}),(0,o.jsx)(i.$s,{children:"Generated Text"}),(0,o.jsx)(i.$s,{children:"Status"}),(0,o.jsx)(i.$s,{children:"Created"}),(0,o.jsx)(i.$s,{children:"Actions"})]})}),(0,o.jsx)(i.jS,{children:te.reduce((e,t,n)=>e.concat(se(t,0,String(n))),[])})]})}),z&&(0,o.jsxs)("div",{className:"mt-3",children:[(0,o.jsx)("h6",{children:"Now playing"}),(0,o.jsx)("audio",{ref:D,controls:!0,style:{width:"100%"}})]}),(0,o.jsxs)(i.zS,{visible:G,onClose:()=>{Q(!1),J(null)},children:[(0,o.jsx)(i.E4,{closeButton:!0,children:(0,o.jsx)(i.lb,{children:"IVR Tree"})}),(0,o.jsx)(i.Tc,{children:P?(0,o.jsx)("div",{className:"text-center py-3",children:(0,o.jsx)(i.JT,{})}):F?(0,o.jsx)("div",{children:(0,o.jsx)(Z,{node:F})}):(0,o.jsx)("div",{className:"text-muted",children:"No tree data available."})}),(0,o.jsx)(i.If,{children:(0,o.jsx)(i.Q_,{color:"secondary",onClick:()=>{Q(!1),J(null)},children:"Close"})})]})]})]})})})}}}]);