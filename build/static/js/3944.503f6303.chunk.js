"use strict";(self.webpackChunk_coreui_coreui_free_react_admin_template=self.webpackChunk_coreui_coreui_free_react_admin_template||[]).push([[3944],{93944:function(e,n,t){t.r(n);var i=t(9950),s=t(49911),a=t(4695),l=t.n(a),r=t(26910),o=t(2720),c=t(44414);n.default=()=>{const[e,n]=(0,i.useState)(""),[t,a]=(0,i.useState)([]),[d,u]=(0,i.useState)(!1),[m,h]=(0,i.useState)(!1),[p,v]=(0,i.useState)(""),[x,f]=(0,i.useState)(""),[j,y]=(0,i.useState)(null),[g,w]=(0,i.useState)(""),[b,N]=(0,i.useState)(""),[C,S]=(0,i.useState)([]),[k,A]=(0,i.useState)({name:"",menu:{welcome:"",options:[],repeat:""},children:[]}),[_,I]=(0,i.useState)([]),[R,T]=(0,i.useState)(!1),B=(0,i.useRef)(null),z=(0,i.useRef)(null),[L,E]=(0,i.useState)(null),[O,U]=(0,i.useState)(null),V=localStorage.getItem("authToken"),[Q,D]=(0,i.useState)(!1),[M,F]=(0,i.useState)(null),[G,$]=(0,i.useState)(!1),W=e=>["#e8fff0","#e8f7ff","#fff7e0","#f7e8ff","#ffffff"][e]||(e%2===0?"#f7f7f7":"#eef7f7"),P=(e,n)=>{if(!n||0===n.length)return e;const[t,...i]=n;return e.children&&e.children[t]?P(e.children[t],i):{name:"",menu:{welcome:"",options:[],repeat:""},children:[]}},J=(e,n,t)=>{if(!n||0===n.length)return t;const[i,...s]=n,a=(e.children||[]).map((e,n)=>n===i?J(e,s,t):e);return{...e,children:a}},H=e=>{var n,t,a;let{path:l,nodeProp:r,onChange:o,level:d=0}=e;const u=r||P(k,l),[m,h]=(0,i.useState)(u),p=(0,i.useRef)(null),[v,x]=(0,i.useState)(()=>new Set),[f,j]=(0,i.useState)(()=>new Set);(0,i.useEffect)(()=>{try{const e=document&&document.activeElement;if(p.current&&e&&p.current.contains(e))return}catch(e){}h(u)},[u]);const y=e=>{h(e)},g=e=>(e||(e=m),w.current&&(clearTimeout(w.current),w.current=null),o?o(e):((e,n)=>{A(t=>J(t,e,n))})(l,e)),w=(0,i.useRef)(null);(0,i.useEffect)(()=>()=>{w.current&&clearTimeout(w.current)},[]);const b=(e,n)=>{var t;const i=((null===(t=m.menu)||void 0===t?void 0:t.options)||[]).map((t,i)=>i===e?n:t),s={...m,menu:{...m.menu,options:i}};y(s)},N=()=>{if(l&&l.length>=0)return(e=>{A(n=>{const t=P(n,e),i={...t,children:[...t.children||[],{name:"",menu:{welcome:"",options:[],repeat:""},children:[]}]};return J(n,e,i)})})(l);const e={...m,children:[...m.children||[],{name:"",menu:{welcome:"",options:[],repeat:""},children:[]}]};y(e),g(e)},C=(Array.isArray(l)?l.length:d)||0,S=m,I=S.children||[];return(0,c.jsxs)("div",{ref:p,className:"border rounded p-2 mb-2",style:{backgroundColor:W(C)},children:[(0,c.jsxs)("div",{className:"mb-2",children:[(0,c.jsx)(s.A6,{children:"name"}),(0,c.jsx)(s.OG,{value:S.name||"",onChange:e=>y({...S,name:e.target.value}),onBlur:()=>g(),placeholder:"name (e.g. menu or SalesMenu)"})]}),(0,c.jsxs)("div",{className:"mb-2",children:[(0,c.jsx)(s.A6,{children:"menu.welcome"}),(0,c.jsx)(s.OG,{value:(null===(n=S.menu)||void 0===n?void 0:n.welcome)||"",onChange:e=>y({...S,menu:{...S.menu,welcome:e.target.value}}),onBlur:()=>g()})]}),(0,c.jsxs)("div",{className:"mb-2",children:[(0,c.jsx)(s.A6,{children:"menu.options[]"}),((null===(t=S.menu)||void 0===t?void 0:t.options)||[]).map((e,n)=>(0,c.jsxs)("div",{className:"mb-2",children:[(0,c.jsxs)("div",{className:"input-group mb-1",children:[(0,c.jsx)(s.OG,{style:{maxWidth:80},value:e.key||"",placeholder:"menu.options[].key",onChange:t=>{const i={...e,key:t.target.value};b(n,i)},onBlur:()=>g()}),(0,c.jsx)(s.OG,{value:e.text||"",placeholder:"menu.options[].text",onChange:t=>b(n,{...e,text:t.target.value}),onBlur:()=>g()}),(0,c.jsxs)("select",{className:"form-control",style:{maxWidth:180,marginRight:6},value:e.destinationType||"menu",onChange:t=>b(n,{...e,destinationType:t.target.value,destination:""}),onBlur:()=>g(),children:[(0,c.jsx)("option",{value:"menu",children:"menu.options[].destination (menu)"}),(0,c.jsx)("option",{value:"did",children:"menu.options[].destination (did)"})]}),"did"===(e.destinationType||"menu")?(0,c.jsxs)("select",{className:"form-control",style:{maxWidth:220},value:e.destination||"",onChange:t=>b(n,{...e,destination:t.target.value}),onBlur:()=>g(),children:[(0,c.jsx)("option",{value:"",children:"menu.options[].destination"}),R?(0,c.jsx)("option",{disabled:!0,children:"Loading..."}):_.map(e=>(0,c.jsx)("option",{value:e.id,children:e.number},e.id))]}):(0,c.jsx)(s.OG,{value:e.destination||"",placeholder:"menu.options[].destination",onChange:t=>b(n,{...e,destination:t.target.value}),onBlur:()=>g()}),(0,c.jsx)("button",{type:"button",className:"btn btn-danger",onClick:()=>(e=>{var n;const t=((null===(n=m.menu)||void 0===n?void 0:n.options)||[]).filter((n,t)=>t!==e),i={...m,menu:{...m.menu,options:t}};y(i),g(i)})(n),children:"Remove"})]}),(0,c.jsxs)("div",{children:[(e.children||[]).map((e,t)=>{const i="opt-".concat(n,"-child-").concat(t),a=v.has(i);return(0,c.jsxs)("div",{className:"ms-3 mb-2",children:[(0,c.jsxs)("div",{className:"d-flex justify-content-between mb-1",children:[(0,c.jsx)("div",{className:"text-muted small",children:e.name||e.fileName||"Child Menu"}),(0,c.jsxs)("div",{children:[(0,c.jsx)(s.Q_,{color:"light",size:"sm",className:"me-2",onClick:()=>{x(e=>{const n=new Set(e);return n.has(i)?n.delete(i):n.add(i),n})},children:a?"Collapse":"Expand"}),(0,c.jsx)("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>((e,n)=>{var t;const i=((null===(t=m.menu)||void 0===t?void 0:t.options)||[]).map((t,i)=>{if(i!==e)return t;const s=(t.children||[]).filter((e,t)=>t!==n);return{...t,children:s}}),s={...m,menu:{...m.menu,options:i}};y(s),g(s)})(n,t),children:"Remove Child"})]})]}),a?(0,c.jsx)(H,{nodeProp:e,level:C+1,onChange:e=>((e,n,t,i)=>{A(s=>{var a;const l=P(s,e),r=((null===(a=l.menu)||void 0===a?void 0:a.options)||[]).map((e,s)=>{if(s!==n)return e;const a=(e.children||[]).map((e,n)=>n===t?i:e);return{...e,children:a}}),o={...l,menu:{...l.menu,options:r}};return J(s,e,o)})})(l,n,t,e)}):null]},t)}),(0,c.jsx)("div",{className:"mt-1",children:(0,c.jsx)(s.Q_,{color:"secondary",size:"sm",onClick:()=>(e=>{var n;const t=(null===(n=m.menu)||void 0===n?void 0:n.options)||[],i={name:"",menu:{welcome:"",options:[],repeat:""},children:[]},s=t.map((n,t)=>t===e?{...n||{},children:[...n&&n.children||[],i]}:n),a={...m,menu:{...m.menu,options:s}};y(a),g(a)})(n),children:"Add Child Menu"})})]})]},n)),(0,c.jsx)("div",{className:"mt-2",children:(0,c.jsx)(s.Q_,{color:"secondary",size:"sm",onClick:()=>(()=>{var e;const n=[...(null===(e=m.menu)||void 0===e?void 0:e.options)||[],{key:"",text:"",destination:"",destinationType:"menu"}],t={...m,menu:{...m.menu,options:n}};y(t),g(t)})(),children:"Add Option"})})]}),(0,c.jsxs)("div",{className:"mb-2",children:[(0,c.jsx)(s.A6,{children:"menu.repeat"}),(0,c.jsx)(s.OG,{value:(null===(a=S.menu)||void 0===a?void 0:a.repeat)||"",onChange:e=>y({...S,menu:{...S.menu,repeat:e.target.value}}),onBlur:()=>g()})]}),(0,c.jsxs)("div",{className:"mb-2",children:[(0,c.jsx)(s.a5,{className:"text-muted",children:"children (unattached)"}),(I||[]).map((e,n)=>{var t;if(e&&e.key&&(e.child||e.children)&&((null===(t=S.menu)||void 0===t?void 0:t.options)||[]).some(n=>n.key===e.key))return null;const i="child-".concat(n),a=f.has(i);return(0,c.jsxs)("div",{className:"ms-3 mb-2",children:[(0,c.jsxs)("div",{className:"d-flex justify-content-between mb-1",children:[(0,c.jsx)("div",{className:"text-muted small",children:e.name||e.fileName||"Child Menu"}),(0,c.jsxs)("div",{children:[(0,c.jsx)(s.Q_,{color:"light",size:"sm",className:"me-2",onClick:()=>j(e=>{const n=new Set(e);return n.has(i)?n.delete(i):n.add(i),n}),children:a?"Collapse":"Expand"}),(0,c.jsx)("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>((e,n)=>{A(t=>{const i=P(t,e),s=(i.children||[]).filter((e,t)=>t!==n),a={...i,children:s};return J(t,e,a)})})(l,n),children:"Remove Child"})]})]}),a?(0,c.jsx)(H,{path:[...l,n],level:C+1}):null]},n)}),(0,c.jsx)("div",{children:(0,c.jsx)(s.Q_,{color:"secondary",size:"sm",onClick:()=>N(),children:"Add Child Menu"})})]})]})};(0,i.useEffect)(()=>{(async()=>{try{const e=await(0,o.H2)("/v1/user/details","GET"),t=e.user||e.data||e;t&&t.businessId&&n(t.businessId)}catch(e){console.warn("Failed to fetch user details",e)}})()},[]),(0,i.useEffect)(()=>{e&&Y()},[e]),(0,i.useEffect)(()=>{if(!e)return;(async()=>{T(!0);try{const n=await(0,o.H2)("/numbers/assigned-to/".concat(e),"GET"),t=n.data||n.numbers||n||[],i=(Array.isArray(t)?t:[]).map(e=>({id:e._id||e.id,number:e.number||e}));I(i)}catch(n){console.warn("Failed to fetch DIDs",n)}finally{T(!1)}})()},[e]),(0,i.useEffect)(()=>()=>{if(L)try{window.URL.revokeObjectURL(L)}catch(e){}},[L]);const Y=async()=>{u(!0);try{const n="".concat((0,o.vo)(),"/api/ivr/tree/menu?businessId=").concat(e),t=await r.A.get(n,{headers:{Authorization:"Bearer ".concat(V)}}),i=t&&t.data?t.data:t,s=i&&(i.tree||i);a(s?Array.isArray(s)?s:[s]:[])}catch(n){console.error("Failed to fetch IVRs",n),a([])}finally{u(!1)}};(0,i.useEffect)(()=>{if(!ne)return;if(0===ne.length)return v(""),f(""),y(null),void A({name:"",menu:{welcome:"",options:[],repeat:""},children:[]});const e=ne[0];v(e.name||""),f(e.description||"");let n=null;n=e.tree?e.tree:e.menu?{name:e.name||"",menu:e.menu,children:e.children||[]}:e;n&&A((e=>{if(!e)return e;const n=new Map;return Array.isArray(e.children)&&e.children.forEach(e=>{e&&e.child&&(e.child._id||e.child.id)?n.set(e.child._id||e.child.id,e.child):e&&(e._id||e.id)&&n.set(e._id||e.id,e)}),e.menu&&Array.isArray(e.menu.options)&&e.menu.options.forEach(e=>{e&&Array.isArray(e.children)&&e.children.forEach(e=>{const t=e&&(e._id||e.ivrId||e.id);t&&e.menu&&n.set(t,e)})}),e.menu&&Array.isArray(e.menu.options)&&(e.menu.options=e.menu.options.map(t=>t?(Array.isArray(t.children)&&(t.children=t.children.map(t=>{const i=t&&(t._id||t.ivrId||t.id);return i&&n.has(i)?n.get(i):t&&t.menu?t:{name:t.name||"",fileName:t.fileName||t.file||"",businessId:t.businessId||e.businessId||"",menu:t.menu||{welcome:"",options:[],repeat:""},children:t.children||[]}})),t):t)),e})(n))},[t]);const K=e=>{var n,t,i;if(!e)return e;return{name:e.name||"menu",menu:{welcome:(null===(n=e.menu)||void 0===n?void 0:n.welcome)||"",options:((null===(t=e.menu)||void 0===t?void 0:t.options)||[]).map(e=>({key:e.key||"",text:e.text||"",destination:e.destination||"",destinationType:e.destinationType||"menu"})),repeat:(null===(i=e.menu)||void 0===i?void 0:i.repeat)||""}}},q=async n=>{const t=n._id||n.id;if(!t)return l().fire({icon:"error",title:"Invalid IVR"});if((await l().fire({title:"Delete IVR?",text:'Delete "'.concat(n.name||"IVR",'"?'),icon:"warning",showCancelButton:!0})).isConfirmed)try{const i=(n.name||"").toString().toLowerCase(),s=(n.fileName||"").toString().toLowerCase();if("menu"===i||s.includes("-menu")){const n="".concat((0,o.vo)(),"/api/ivr/nested/menu?businessId=").concat(e);await r.A.delete(n,{headers:{Authorization:"Bearer ".concat(V)}})}else await(0,o.H2)("/api/ivr/".concat(t),"DELETE");l().fire({icon:"success",title:"Deleted"}),await Y()}catch(i){console.error("Delete IVR failed",i),l().fire({icon:"error",title:"Delete failed",text:(null===i||void 0===i?void 0:i.message)||"Delete failed"})}},X=async n=>{const t=n.name||n.fileName||n.file||"";if(!t)return l().fire({icon:"error",title:"No tree",text:"No tree available for this IVR."});$(!0);try{const n="".concat((0,o.vo)(),"/api/ivr/tree/").concat(encodeURIComponent(t),"?businessId=").concat(e),i=await r.A.get(n,{headers:{Authorization:"Bearer ".concat(V)}}),s=(i.data&&(i.data.tree||i.data)&&(i.data.tree||i.data.tree||i.data),i.data&&i.data.tree?i.data.tree:i.data&&void 0===i.data.tree?i.data:null);F(s||i.data||null),D(!0)}catch(a){var i,s;console.error("Fetch tree failed",a),l().fire({icon:"error",title:"Fetch failed",text:(null===a||void 0===a||null===(i=a.response)||void 0===i||null===(s=i.data)||void 0===s?void 0:s.message)||(null===a||void 0===a?void 0:a.message)||"Could not fetch tree"})}finally{$(!1)}},Z=e=>{let{node:n,level:t=0}=e;if(!n)return null;const i={marginLeft:"".concat(12*t,"px"),borderLeft:0===t?"none":"1px dashed #ccc",paddingLeft:"8px"},s=n.menu||{},a=n.children||[];return(0,c.jsxs)("div",{style:{...i,backgroundColor:W(t),borderRadius:4},className:"mb-2 p-2",children:[(0,c.jsxs)("div",{children:[(0,c.jsx)("strong",{children:n.name||n.fileName||"Menu"})," ",n.fileName?(0,c.jsxs)("span",{className:"text-muted",children:["(",n.fileName,")"]}):null]}),s.welcome?(0,c.jsx)("div",{className:"text-muted",children:s.welcome}):null,s.options&&s.options.length>0&&(0,c.jsxs)("div",{className:"mt-1",children:[(0,c.jsx)("small",{className:"text-muted",children:"Options:"}),(0,c.jsx)("ul",{children:s.options.map((e,n)=>(0,c.jsxs)("li",{children:[e.key,": ",e.text," \u2192 ",e.destination]},e._id||n))})]}),s.repeat?(0,c.jsxs)("div",{className:"text-muted",children:["Repeat: ",s.repeat]}):null,s.options&&s.options.length>0&&(0,c.jsxs)("div",{className:"mt-2",children:[(0,c.jsx)("small",{className:"text-muted",children:"Option Children:"}),(0,c.jsx)("div",{children:s.options.map((e,n)=>e.children&&e.children.length>0?(0,c.jsxs)("div",{className:"mb-2",children:[(0,c.jsxs)("div",{className:"text-muted",children:["On press ",(0,c.jsx)("strong",{children:e.key})," \u2192 ",e.text]}),e.children.map((e,n)=>(0,c.jsx)("div",{className:"ms-3 mb-1",children:(0,c.jsx)(Z,{node:e,level:t+1})},n))]},n):null)})]}),a&&a.length>0&&(0,c.jsxs)("div",{className:"mt-2",children:[(0,c.jsx)("small",{className:"text-muted",children:"Children:"}),(0,c.jsx)("div",{children:a.map((e,n)=>e&&e.child?(0,c.jsxs)("div",{className:"mb-2",children:[(0,c.jsxs)("div",{className:"text-muted",children:["On press ",(0,c.jsx)("strong",{children:e.key})," \u2192 ",e.destination]}),(0,c.jsx)(Z,{node:e.child,level:t+1})]},n):(0,c.jsx)(Z,{node:e,level:t+1},n))})]})]})},ee=()=>{try{if(z.current&&(z.current.pause(),z.current.currentTime=0,z.current.src=""),L)try{window.URL.revokeObjectURL(L)}catch(e){}}finally{E(null),U(null)}},ne=t.filter(e=>{const n=(e.name||"").toString().toLowerCase();return"menu"===n||"main"===n||"root"===n||(!!(e.menu&&Array.isArray(e.children)&&e.children.length>0)||(!!(Array.isArray(e.children)&&e.children.length>0)||!!e.uploadedToAsterisk))}),[te,ie]=(0,i.useState)([]),se=e=>te.includes(e),[ae,le]=(0,i.useState)([]),re=e=>ae.includes(e),oe=async(n,t)=>{const i=n._id||n.id||n.name;if(!i)return l().fire({icon:"error",title:"Invalid IVR"});const s=(n.ivrStatus||n.status||n.state||"").toString().toLowerCase(),a="boolean"===typeof t?t?"on":"off":"off"===s||"on"===s||"active"===s?"off":"on";try{le(e=>[...e,i]);const t={action:a,name:n.name||n.fileName||n.file||"",businessId:e},s="".concat((0,o.vo)(),"/api/ivr/switch");await r.A.post(s,t,{headers:{Authorization:"Bearer ".concat(V),"Content-Type":"application/json"}}),l().fire({icon:"success",title:"Switched ".concat(a)}),await Y()}catch(u){var c,d;console.error("Switch failed",u);const e=(null===u||void 0===u||null===(c=u.response)||void 0===c||null===(d=c.data)||void 0===d?void 0:d.message)||(null===u||void 0===u?void 0:u.message)||"Switch failed";l().fire({icon:"error",title:"Switch failed",text:e})}finally{le(e=>e.filter(e=>e!==i))}},ce=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(!e)return[];const i=e._id||e.name||t||Math.random().toString(36).slice(2),a=e._id||e.id||e.name||i,d={paddingLeft:"".concat(18*n,"px")},u=[];return u.push((0,c.jsxs)(s.YI,{style:{backgroundColor:W(n)},children:[(0,c.jsx)(s.cC,{children:(0,c.jsxs)("div",{style:d,className:"d-flex align-items-center",children:[e.children&&e.children.length>0?(0,c.jsx)(s.Q_,{color:"light",size:"sm",className:"me-2",onClick:()=>{return e=i,void ie(n=>n.includes(e)?n.filter(n=>n!==e):[...n,e]);var e},children:se(i)?"\u25be":"\u25b8"}):(0,c.jsx)("span",{style:{width:34}}),(0,c.jsxs)("div",{children:[(0,c.jsx)("div",{children:(0,c.jsx)("strong",{children:e.name||"Menu"})}),e.menu&&e.menu.welcome?(0,c.jsx)("div",{className:"text-muted small",children:e.menu.welcome}):null]})]})}),(0,c.jsx)(s.cC,{children:e.name||e.fileName?(0,c.jsx)(s.Q_,{color:"link",size:"sm",className:"p-0",onClick:()=>(async e=>{const n=e.name||e.fileName||e.file||"";if(!n)return l().fire({icon:"error",title:"No audio",text:"No audio file available for this IVR."});try{const e="".concat((0,o.vo)(),"/api/ivr/download/").concat(encodeURIComponent(n)),t=await r.A.get(e,{responseType:"arraybuffer",headers:{Authorization:"Bearer ".concat(V)}}),i=t.headers&&t.headers["content-type"]?t.headers["content-type"]:"audio/wav",s=new Blob([t.data],{type:i}),a=window.URL.createObjectURL(s);window.open(a,"_blank"),setTimeout(()=>{try{window.URL.revokeObjectURL(a)}catch(e){}},6e4)}catch(i){var t;console.error("Open failed",i),l().fire({icon:"error",title:"Open failed",text:(null===i||void 0===i||null===(t=i.response)||void 0===t?void 0:t.data)||(null===i||void 0===i?void 0:i.message)||"Could not open audio"})}})(e),children:e.name||e.fileName}):e.audio?(0,c.jsx)("a",{href:e.audio,target:"_blank",rel:"noreferrer",children:"Play"}):"-"}),(0,c.jsx)(s.cC,{style:{maxWidth:300,overflow:"hidden",textOverflow:"ellipsis"},children:e.menu&&e.menu.options&&e.menu.options.map(e=>"".concat(e.key,":").concat(e.text)).join(", ")||e.generatedText||"-"}),(0,c.jsxs)(s.cC,{children:[re(a)&&(0,c.jsx)(s.JT,{size:"sm",className:"me-2"}),(()=>{const n="on"===(e.ivrStatus||e.status||e.state||"").toString().toLowerCase()||"active"===(e.ivrStatus||e.status||"").toString().toLowerCase();return(0,c.jsx)(s.Qb,{checked:n,className:"me-2",disabled:re(a),onChange:n=>oe(e,n.target.checked)})})()]}),(0,c.jsxs)(s.cC,{children:[(0,c.jsx)(s.Q_,{color:"secondary",size:"sm",className:"me-2",onClick:()=>X(e),children:"View Tree"}),(0,c.jsx)(s.Q_,{color:"danger",size:"sm",onClick:()=>q(e),children:"Delete"})]})]},"node-".concat(i))),se(i)&&e.children&&e.children.length>0&&e.children.forEach((e,a)=>{e&&e.child?(u.push((0,c.jsx)(s.YI,{style:{backgroundColor:W(n+1)},children:(0,c.jsx)(s.cC,{colSpan:5,children:(0,c.jsxs)("div",{style:{paddingLeft:"".concat(18*(n+1),"px")},className:"text-muted small",children:["On press ",(0,c.jsx)("strong",{children:e.key})," \u2192 ",e.destination]})})},"opt-".concat(i,"-").concat(a))),u.push(...ce(e.child,n+1,"".concat(t,"/").concat(a)))):u.push(...ce(e,n+1,"".concat(t,"/").concat(a)))}),u};return(0,c.jsx)("div",{className:"p-3",children:(0,c.jsx)(s.E$,{children:(0,c.jsxs)(s.W6,{children:[(0,c.jsxs)(s.sK,{className:"align-items-center mb-3",children:[(0,c.jsxs)(s.UF,{children:[(0,c.jsx)("h3",{children:"IVR Management"}),(0,c.jsx)("p",{className:"text-muted",children:"Create and manage IVR flows and audio prompts."})]}),(0,c.jsx)(s.UF,{className:"text-end"})]}),m&&(0,c.jsx)(s.E$,{className:"mb-4",children:(0,c.jsxs)(s.W6,{children:[(0,c.jsxs)(s.sK,{className:"align-items-center mb-3",children:[(0,c.jsx)(s.UF,{children:(0,c.jsx)("h4",{className:"mb-0",children:"New IVR"})}),(0,c.jsx)(s.UF,{className:"text-end",children:(0,c.jsx)(s.Q_,{color:"secondary",onClick:()=>h(!1),children:"Back"})})]}),(0,c.jsxs)("div",{className:"mb-3",children:[(0,c.jsx)(s.A6,{children:"name"}),(0,c.jsx)(s.OG,{value:p,onChange:e=>v(e.target.value),placeholder:"name"})]}),(0,c.jsxs)("div",{className:"mb-3",children:[(0,c.jsx)(s.A6,{children:"description"}),(0,c.jsx)(s.OG,{value:x,onChange:e=>f(e.target.value),placeholder:"description"})]}),(0,c.jsxs)("div",{className:"mb-3",children:[(0,c.jsx)(s.A6,{children:"Build Menu (visual editor)"}),(0,c.jsx)(H,{path:[]}),(0,c.jsx)(s.a5,{className:"text-muted",children:"Use the visual editor to build a nested menu tree. Top-level node name will default to the IVR name if left empty."})]}),(0,c.jsxs)("div",{className:"text-end",children:[(0,c.jsx)(s.Q_,{color:"secondary",onClick:()=>h(!1),children:"Cancel"}),(0,c.jsx)(s.Q_,{color:"primary",onClick:async()=>{if(e)try{if(k&&(k.menu&&(k.menu.welcome||k.menu.options&&k.menu.options.length>0||k.menu.repeat)||k.children&&k.children.length>0)){const n=K(k);n.name||(n.name=p||"menu");const t="".concat((0,o.vo)(),"/api/ivr/create-nested");await r.A.post(t,{businessId:e,tree:n},{headers:{Authorization:"Bearer ".concat(V),"Content-Type":"application/json"}})}else if(j){const n=new FormData;n.append("name",p),n.append("description",x),n.append("businessId",e),n.append("audio",j);const t="".concat((0,o.vo)(),"/api/ivr");await r.A.post(t,n,{headers:{Authorization:"Bearer ".concat(V),"Content-Type":"multipart/form-data"}})}else{const n="".concat((0,o.vo)(),"/api/ivr");await r.A.post(n,{name:p,description:x,businessId:e},{headers:{Authorization:"Bearer ".concat(V),"Content-Type":"application/json"}})}l().fire({icon:"success",title:"IVR Created"}),h(!1),v(""),f(""),y(null),w(""),N(""),S([]),A({name:"",menu:{welcome:"",options:[],repeat:""},children:[]}),B.current&&(B.current.value=""),await Y()}catch(i){var n,t;console.error("Create IVR failed",i);const e=(null===i||void 0===i||null===(n=i.response)||void 0===n||null===(t=n.data)||void 0===t?void 0:t.message)||i.message||"Create failed";l().fire({icon:"error",title:"Create failed",text:e})}else l().fire({icon:"warning",title:"Missing fields",text:"Business ID not available."})},className:"ms-2",children:"Create"})]})]})}),(0,c.jsxs)("div",{className:"mt-4",children:[(0,c.jsx)("h5",{children:"IVR Settings"}),d?(0,c.jsx)("div",{className:"py-3 text-center",children:(0,c.jsx)(s.JT,{})}):ne.length<=1?(()=>{const n=ne[0],t=n&&(n._id||n.id||n.name),i=!(!n||"on"!==(n.ivrStatus||n.status||n.state||"").toString().toLowerCase()&&"active"!==(n.ivrStatus||n.status||"").toString().toLowerCase());return(0,c.jsx)(s.E$,{children:(0,c.jsxs)(s.W6,{children:[(0,c.jsxs)("div",{className:"mb-3",children:[(0,c.jsx)(s.A6,{children:"Build Menu (visual editor)"}),(0,c.jsx)(H,{path:[]}),(0,c.jsx)(s.a5,{className:"text-muted",children:"Use the visual editor to build a nested menu tree."})]}),n&&(0,c.jsxs)("div",{className:"mb-3 d-flex align-items-center",children:[(0,c.jsx)("strong",{className:"me-2",children:"Status:"}),re(t)&&(0,c.jsx)(s.JT,{size:"sm",className:"me-2"}),(0,c.jsx)(s.Qb,{checked:i,className:"me-2",disabled:re(t),onChange:e=>oe(n,e.target.checked)})]}),(0,c.jsxs)("div",{className:"text-end",children:[n&&(0,c.jsx)(s.Q_,{color:O===(n._id||n.id||n.name)?"warning":"info",size:"sm",className:"me-2",onClick:()=>(async e=>{const n=e._id||e.id||e.name,t=e.name||e.fileName||e.file||"";if(!t)return l().fire({icon:"error",title:"No audio",text:"No audio file available for this IVR."});if(O!==n)try{ee();const e="".concat((0,o.vo)(),"/api/ivr/download/").concat(encodeURIComponent(t)),n=await r.A.get(e,{responseType:"blob",headers:{Authorization:"Bearer ".concat(V)}}),i=new Blob([n.data],{type:n.data.type||"audio/wav"}),s=window.URL.createObjectURL(i);window.open(s,"_blank"),setTimeout(()=>{try{window.URL.revokeObjectURL(s)}catch(e){}},6e4)}catch(a){var i,s;console.error("Play failed",a),l().fire({icon:"error",title:"Play failed",text:(null===a||void 0===a||null===(i=a.response)||void 0===i||null===(s=i.data)||void 0===s?void 0:s.message)||(null===a||void 0===a?void 0:a.message)||"Could not play audio"})}else ee()})(n),children:O===(n._id||n.id||n.name)?"Stop":"Play"}),n&&(0,c.jsx)(s.Q_,{color:"secondary",size:"sm",className:"me-2",onClick:()=>X(n),children:"View Tree"}),n&&(0,c.jsx)(s.Q_,{color:"danger",size:"sm",className:"me-2",onClick:()=>q(n),children:"Delete"}),(0,c.jsx)(s.Q_,{color:"primary",onClick:()=>(async n=>{if(!e)return l().fire({icon:"warning",title:"Missing business",text:"Business ID not available"});try{if(k&&(k.menu&&(k.menu.welcome||k.menu.options&&k.menu.options.length>0||k.menu.repeat)||k.children&&k.children.length>0)){const n=K(k);n.name||(n.name=p||"menu");const t="".concat((0,o.vo)(),"/api/ivr/create-nested");await r.A.post(t,{businessId:e,tree:n},{headers:{Authorization:"Bearer ".concat(V),"Content-Type":"application/json"}})}else if(j){const n=new FormData;n.append("name",p),n.append("description",x),n.append("businessId",e),n.append("audio",j);const t="".concat((0,o.vo)(),"/api/ivr");await r.A.post(t,n,{headers:{Authorization:"Bearer ".concat(V),"Content-Type":"multipart/form-data"}})}else{const n="".concat((0,o.vo)(),"/api/ivr");await r.A.post(n,{name:p,description:x,businessId:e},{headers:{Authorization:"Bearer ".concat(V),"Content-Type":"application/json"}})}l().fire({icon:"success",title:n?"Saved":"Created"}),B.current&&(B.current.value=""),y(null),await Y()}catch(s){var t,i;console.error("Save failed",s);const e=(null===s||void 0===s||null===(t=s.response)||void 0===t||null===(i=t.data)||void 0===i?void 0:i.message)||(null===s||void 0===s?void 0:s.message)||"Save failed";l().fire({icon:"error",title:"Save failed",text:e})}})(n),children:n?"Save":"Create"})]})]})})})():(0,c.jsx)("div",{className:"table-responsive",children:(0,c.jsxs)(s._v,{children:[(0,c.jsx)(s.wV,{children:(0,c.jsxs)(s.YI,{children:[(0,c.jsx)(s.$s,{children:"Name"}),(0,c.jsx)(s.$s,{children:"File"}),(0,c.jsx)(s.$s,{children:"Generated Text"}),(0,c.jsx)(s.$s,{children:"Status"}),(0,c.jsx)(s.$s,{children:"Actions"})]})}),(0,c.jsx)(s.jS,{children:ne.reduce((e,n,t)=>e.concat(ce(n,0,String(t))),[])})]})}),L&&(0,c.jsxs)("div",{className:"mt-3",children:[(0,c.jsx)("h6",{children:"Now playing"}),(0,c.jsx)("audio",{ref:z,controls:!0,style:{width:"100%"}})]}),(0,c.jsxs)(s.zS,{visible:Q,onClose:()=>{D(!1),F(null)},children:[(0,c.jsx)(s.E4,{closeButton:!0,children:(0,c.jsx)(s.lb,{children:"IVR Tree"})}),(0,c.jsx)(s.Tc,{children:G?(0,c.jsx)("div",{className:"text-center py-3",children:(0,c.jsx)(s.JT,{})}):M?(0,c.jsx)("div",{children:(0,c.jsx)(Z,{node:M})}):(0,c.jsx)("div",{className:"text-muted",children:"No tree data available."})}),(0,c.jsx)(s.If,{children:(0,c.jsx)(s.Q_,{color:"secondary",onClick:()=>{D(!1),F(null)},children:"Close"})})]})]})]})})})}}}]);