"use strict";(self.webpackChunk_coreui_coreui_free_react_admin_template=self.webpackChunk_coreui_coreui_free_react_admin_template||[]).push([[8664],{88664:function(e,n,t){t.r(n),t.d(n,{default:function(){return u}});var i=t(9950),s=t(49911),o=t(2720),r=t(94151),l=t.n(r);var c=e=>{let{sipConfig:n={},enableDebug:t=!1,onRegistrationStatus:s=()=>{},onUaReady:o=()=>{}}=e;const r=(0,i.useRef)(null);return(0,i.useEffect)(()=>{if(!n||!n.extension||!n.sip_password||!n.sip_domain)return void(s&&s("missing-config"));try{if(window.sipUA&&"object"===typeof window.sipUA&&window.sipUA.isRegistered&&window.sipUA.isRegistered()){s&&s("registered");try{o&&o(window.sipUA)}catch(p){console.warn("onUaReady failed",p)}return}}catch(p){}const e=n.ws_path||"/ws",i=n.ws_port||(!1!==n.wss?8089:8088),c=!1!==n.wss?"wss":"ws",a="".concat(c,"://").concat(n.sip_domain,":").concat(i).concat(e),d="sip:".concat(n.extension,"@").concat(n.sip_domain);let u=null,g=!1;const h=()=>{u&&(clearTimeout(u),u=null)},v=()=>{if(g)return;g=!0,console.warn("SipRegistration: attempting fallback to same-origin websocket");const n="https:"===window.location.protocol?"wss":"ws",t="".concat(n,"://").concat(window.location.host).concat(e);f(t,!1)},f=function(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{if(r.current){try{r.current.stop()}catch(p){}r.current=null}const c=(e=>({sockets:[e],uri:d,password:n.sip_password,register:!0,session_timers:!1,register_expires:n.register_expires||600,pcConfig:{iceServers:n.iceServers||[{urls:"stun:stun.l.google.com:19302"}]}}))(new(l().WebSocketInterface)(e));t&&l().debug.enable("JsSIP:*");const a=new(l().UA)(c);r.current=a,window.sipUA=a,a.on("connecting",()=>s&&s("connecting")),a.on("connected",()=>s&&s("connected")),a.on("registered",()=>{h(),s&&s("registered");try{o&&o(a)}catch(p){console.warn("onUaReady failed",p)}}),a.on("unregistered",()=>s&&s("unregistered")),a.on("registrationFailed",e=>{console.warn("JsSIP registration failed",e),s&&s("failed")}),a.on("newRTCSession",e=>{const n=e.session;n.on("ended",()=>console.debug("session ended",n)),n.on("failed",()=>console.debug("session failed",n))}),a.start(),s&&s("connecting"),h(),u=setTimeout(()=>{console.warn("SipRegistration: connection timeout; no registration yet"),i&&v()},n.connection_timeout_ms||5e3)}catch(c){console.error("Failed to initialize JsSIP UA with",e,c),s&&s("failed"),g||e===a||v()}};return f(a,!0),()=>{try{r.current&&(r.current.stop(),r.current=null)}catch(p){}}},[JSON.stringify(n)]),null},a=t(44414);var d=e=>{let{session:n}=e;const t=(0,i.useRef)(null);return(0,i.useEffect)(()=>{if(!n||!t.current)return;(()=>{try{const e=n.connection;if(!e)return;const i=e.getRemoteStreams?e.getRemoteStreams():[];if(i&&i.length)return t.current.srcObject=i[0],void t.current.play().catch(()=>{});const s=e.getReceivers?e.getReceivers():[];if(s.length){const e=new MediaStream;s.forEach(n=>{n.track&&e.addTrack(n.track)}),t.current.srcObject=e,t.current.play().catch(()=>{})}}catch(e){console.warn("Failed to attach remote audio",e)}})();const e=e=>{try{t.current.srcObject=e.stream,t.current.play().catch(()=>{})}catch(n){console.warn("onaddstream attach failed",n)}};try{n.connection&&n.connection.addEventListener&&n.connection.addEventListener("addstream",e)}catch(i){}return()=>{try{n.connection&&n.connection.removeEventListener&&n.connection.removeEventListener("addstream",e)}catch(i){}}},[n]),(0,a.jsx)("audio",{ref:t,style:{width:"100%"},controls:!0,autoPlay:!0})};var u=()=>{var e,n,t,r,l,u;const[g,h]=(0,i.useState)(""),[v,f]=(0,i.useState)(!1),[p,x]=(0,i.useState)(null),[m,j]=(0,i.useState)([]),[y,w]=(0,i.useState)([]),b=(0,i.useRef)(null),[S,C]=(0,i.useState)("disconnected"),[_,A]=(0,i.useState)(null),[k,I]=(0,i.useState)(null),[R,U]=(0,i.useState)(null),[$,E]=(0,i.useState)(null),[T,z]=(0,i.useState)(null),[L,O]=(0,i.useState)(null),[D,F]=(0,i.useState)(null),M=async()=>{x(null);try{const e=await(async()=>{if(g)return g;try{const e=await(0,o.H2)("/v1/user/details","GET"),n=e.user||e.data||e;if(n&&n.businessId)return h(n.businessId),n.businessId}catch(e){}return null})();if(!e)return x("Business ID not available"),j([]),void w([]);f(!0);const n=await(0,o.H2)("/asterisk/livecalls/".concat(encodeURIComponent(e)),"GET"),t=Array.isArray(n.liveCalls)?n.liveCalls:[],i=Array.isArray(n.logicalCalls)?n.logicalCalls:[];j(t),w(i)}catch(t){var e,n;console.error("CallMonitor fetch failed",t),x((null===t||void 0===t||null===(e=t.response)||void 0===e||null===(n=e.data)||void 0===n?void 0:n.message)||t.message||"Failed to fetch live calls"),j([]),w([])}finally{f(!1)}};(0,i.useEffect)(()=>(M(),b.current=setInterval(()=>{M()},5e3),()=>{b.current&&clearInterval(b.current)}),[]);const P={sip_domain:"pbx.justconnect.biz",extension:"1036",sip_password:"secure_password_1036",ws_port:8089,ws_path:"/ws",wss:!0,iceServers:[{urls:"stun:stun.l.google.com:19302"}]},W=e=>{var n,t;const i=(null===e||void 0===e?void 0:e.assignedAgent)||(null===e||void 0===e?void 0:e.agent);if(i)if("object"===typeof i){if(i.extension)return String(i.extension);if(i.ext)return String(i.ext);if(i.sipExtension)return String(i.sipExtension)}else if("string"===typeof i&&/^\d+$/.test(i))return i;const s=(null===e||void 0===e?void 0:e.channel)||(null===e||void 0===e||null===(n=e.legs)||void 0===n||null===(t=n[0])||void 0===t?void 0:t.channel);if(s&&"string"===typeof s){const e=s.match(/\/(\d+)(?:-|$)/);if(e&&e[1])return e[1]}if(null!==e&&void 0!==e&&e.agent&&"string"===typeof e.agent&&/\d+/.test(e.agent)){const n=e.agent.match(/(\d{3,})/);if(n)return n[1]}return null};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.sK,{children:(0,a.jsx)(s.UF,{children:(0,a.jsx)(s.E$,{children:(0,a.jsxs)("div",{children:[(0,a.jsx)("style",{children:"\n                .compact-table th, .compact-table td { padding: 0.25rem 0.4rem !important; vertical-align: middle !important; line-height: 1.15 !important; }\n                .compact-table td { overflow: hidden; text-overflow: ellipsis; }\n              "}),(0,a.jsxs)(s.V0,{className:"d-flex justify-content-between align-items-center",children:[(0,a.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:12},children:[(0,a.jsx)("h3",{style:{margin:0},children:"Call Monitor"}),(0,a.jsx)(s.$X,{color:"registered"===S?"success":"connected"===S?"info":"connecting"===S?"warning":"secondary",children:S})]}),(0,a.jsx)("div",{children:(0,a.jsx)("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:M,disabled:v,children:v?"Refreshing":"Refresh"})})]}),(0,a.jsxs)(s.W6,{children:[(0,a.jsx)(c,{sipConfig:P,enableDebug:!1,onRegistrationStatus:C,onUaReady:e=>A(e)}),p&&(0,a.jsx)("div",{style:{color:"var(--cui-danger)"},children:p}),(0,a.jsx)("div",{style:{marginTop:12},children:v&&!m.length?(0,a.jsxs)("div",{style:{padding:20},children:[(0,a.jsx)(s.JT,{}),"\xa0Loading live calls..."]}):(0,a.jsx)(a.Fragment,{children:0===m.length?(0,a.jsx)("div",{style:{padding:20},children:(0,a.jsx)(s.$X,{color:"secondary",children:"No active calls"})}):(0,a.jsxs)(s._v,{striped:!0,hover:!0,responsive:!0,className:"table-sm compact-table",style:{tableLayout:"auto"},children:[(0,a.jsx)(s.wV,{children:(0,a.jsxs)(s.YI,{children:[(0,a.jsx)(s.$s,{children:"Direction"}),(0,a.jsx)(s.$s,{children:"Channel"}),(0,a.jsx)(s.$s,{children:"Status"}),(0,a.jsx)(s.$s,{children:"Duration"}),(0,a.jsx)(s.$s,{children:"DID"}),(0,a.jsx)(s.$s,{children:"Agent"}),(0,a.jsx)(s.$s,{children:"Branch"}),(0,a.jsx)(s.$s,{children:"Raw"}),(0,a.jsx)(s.$s,{children:"Actions"})]})}),(0,a.jsx)(s.jS,{children:m.map((e,n)=>{var t,i,o,r,l;return(0,a.jsxs)(s.YI,{children:[(0,a.jsx)(s.cC,{children:(()=>{const n=(e=>{const n=e.legs&&e.legs[0]||e,t=String((null===n||void 0===n?void 0:n.raw)||(null===e||void 0===e?void 0:e.raw)||"").toLowerCase(),i=Array.isArray((null===n||void 0===n?void 0:n.tokens)||(null===e||void 0===e?void 0:e.tokens))&&((null===n||void 0===n?void 0:n.tokens)||(null===e||void 0===e?void 0:e.tokens))||[],s=/^\+?\d{7,15}$/,o=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i,r=i.filter(e=>"string"===typeof e&&s.test(e)),l=i.filter(e=>"string"===typeof e&&o.test(e));return r.length>0&&r.length>=1?"Outgoing":l.length>0&&0===r.length||/\bincoming\b/i.test(t)||/from-external/i.test(t)?"Inbound":/\boutgoing\b/i.test(t)||/outbound/i.test(t)||/\bdial\b/i.test(t)||r.length>0?"Outgoing":"Inbound"})(e);return(0,a.jsx)(s.$X,{color:"Outgoing"===n?"primary":"Inbound"===n?"info":"secondary",children:n})})()}),(0,a.jsx)(s.cC,{children:e.channel||"-"}),(0,a.jsx)(s.cC,{children:(0,a.jsx)(s.$X,{color:"up"===String(e.status||"").toLowerCase()?"success":"ring"===String(e.status||"").toLowerCase()?"warning":"secondary",children:e.status||"-"})}),(0,a.jsx)(s.cC,{children:e.duration||"-"}),(0,a.jsx)(s.cC,{children:(null===(t=e.did)||void 0===t?void 0:t.number)||(null===(i=e.tokens)||void 0===i?void 0:i[3])||"-"}),(0,a.jsx)(s.cC,{children:(null===(o=e.assignedAgent)||void 0===o?void 0:o.name)||(null===(r=e.assignedAgent)||void 0===r?void 0:r.email)||"-"}),(0,a.jsx)(s.cC,{children:(null===(l=e.branch)||void 0===l?void 0:l.branchName)||"-"}),(0,a.jsx)(s.cC,{style:{maxWidth:400,overflow:"hidden",textOverflow:"ellipsis"},children:e.raw||"-"}),(0,a.jsx)(s.cC,{children:(0,a.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,a.jsx)(s.Q_,{size:"sm",color:"info",onClick:()=>(async e=>{const n=W(e);if(!n)return void alert("Could not determine extension to monitor for this call.");if(!_)return void alert("SIP UA not ready; please wait for registration.");const t=_.configuration&&_.configuration.uri&&_.configuration.uri.host||P.sip_domain||"",i="*90".concat(n),s=t?"sip:".concat(i,"@").concat(t):"sip:".concat(i);try{const n={mediaConstraints:{audio:!0,video:!1},pcConfig:{iceServers:P.iceServers}},t=_.call(s,n);I(t),U(e),t.on&&t.on("ended",()=>{I(null),U(null)}),t.on&&t.on("failed",()=>{I(null),U(null)})}catch(o){console.error("Monitor failed",o),alert("Monitor failed: "+String(o))}})(e),disabled:"registered"!==S||!_,children:"Monitor"}),(0,a.jsx)(s.Q_,{size:"sm",color:"warning",onClick:()=>(async e=>{const n=W(e);if(!n)return void alert("Could not determine extension to whisper for this call.");if(!_)return void alert("SIP UA not ready; please wait for registration.");const t=_.configuration&&_.configuration.uri&&_.configuration.uri.host||P.sip_domain||"",i="*91".concat(n),s=t?"sip:".concat(i,"@").concat(t):"sip:".concat(i);try{const n={mediaConstraints:{audio:!0,video:!1},pcConfig:{iceServers:P.iceServers}},t=_.call(s,n);E(t),z(e),t.on&&t.on("ended",()=>{E(null),z(null)}),t.on&&t.on("failed",()=>{E(null),z(null)})}catch(o){console.error("Whisper failed",o),alert("Whisper failed: "+String(o))}})(e),disabled:"registered"!==S||!_,children:"Whisper"}),(0,a.jsx)(s.Q_,{size:"sm",color:"success",onClick:()=>(async e=>{const n=W(e);if(!n)return void alert("Could not determine extension to barge for this call.");if(!_)return void alert("SIP UA not ready; please wait for registration.");const t=_.configuration&&_.configuration.uri&&_.configuration.uri.host||P.sip_domain||"",i="*92".concat(n),s=t?"sip:".concat(i,"@").concat(t):"sip:".concat(i);try{const n={mediaConstraints:{audio:!0,video:!1},pcConfig:{iceServers:P.iceServers}},t=_.call(s,n);O(t),F(e),t.on&&t.on("ended",()=>{O(null),F(null)}),t.on&&t.on("failed",()=>{O(null),F(null)})}catch(o){console.error("Barge failed",o),alert("Barge failed: "+String(o))}})(e),disabled:"registered"!==S||!_,children:"Barge"})]})})]},"".concat(e.channel||e.groupId||n,"-").concat(n))})})]})})})]})]})})})}),k&&(0,a.jsxs)("div",{style:{position:"fixed",bottom:16,right:16,width:360,background:"white",padding:12,borderRadius:8,boxShadow:"0 6px 18px rgba(0,0,0,0.1)"},children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,a.jsxs)("div",{children:["Monitoring ",(0,a.jsx)("strong",{children:(null===R||void 0===R||null===(e=R.assignedAgent)||void 0===e?void 0:e.name)||(null===R||void 0===R||null===(n=R.assignedAgent)||void 0===n?void 0:n.email)||(null===R||void 0===R?void 0:R.agent)||"agent"})]}),(0,a.jsx)("div",{children:(0,a.jsx)(s.Q_,{size:"sm",color:"danger",onClick:()=>{try{k.terminate()}catch(e){}I(null),U(null)},children:"Hangup"})})]}),(0,a.jsx)("div",{style:{marginTop:8},children:(0,a.jsx)(d,{session:k})})]}),$&&(0,a.jsxs)("div",{style:{position:"fixed",bottom:16,right:16,width:360,background:"white",padding:12,borderRadius:8,boxShadow:"0 6px 18px rgba(0,0,0,0.1)",zIndex:1100},children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,a.jsxs)("div",{children:["Whispering to ",(0,a.jsx)("strong",{children:(null===T||void 0===T||null===(t=T.assignedAgent)||void 0===t?void 0:t.name)||(null===T||void 0===T||null===(r=T.assignedAgent)||void 0===r?void 0:r.email)||(null===T||void 0===T?void 0:T.agent)||"agent"})]}),(0,a.jsx)("div",{children:(0,a.jsx)(s.Q_,{size:"sm",color:"danger",onClick:()=>{try{$.terminate()}catch(e){}E(null),z(null)},children:"Hangup"})})]}),(0,a.jsx)("div",{style:{marginTop:8},children:(0,a.jsx)(d,{session:$})})]}),L&&(0,a.jsxs)("div",{style:{position:"fixed",bottom:16,right:16,width:360,background:"white",padding:12,borderRadius:8,boxShadow:"0 6px 18px rgba(0,0,0,0.1)",zIndex:1090},children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,a.jsxs)("div",{children:["Barging into ",(0,a.jsx)("strong",{children:(null===D||void 0===D||null===(l=D.assignedAgent)||void 0===l?void 0:l.name)||(null===D||void 0===D||null===(u=D.assignedAgent)||void 0===u?void 0:u.email)||(null===D||void 0===D?void 0:D.agent)||"agent"})]}),(0,a.jsx)("div",{children:(0,a.jsx)(s.Q_,{size:"sm",color:"danger",onClick:()=>{try{L.terminate()}catch(e){}O(null),F(null)},children:"Hangup"})})]}),(0,a.jsx)("div",{style:{marginTop:8},children:(0,a.jsx)(d,{session:L})})]})]})}}}]);