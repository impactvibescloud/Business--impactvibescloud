"use strict";(self.webpackChunk_coreui_coreui_free_react_admin_template=self.webpackChunk_coreui_coreui_free_react_admin_template||[]).push([[8664],{88664:function(e,n,i){i.r(n),i.d(n,{default:function(){return u}});var t=i(9950),s=i(49911),r=i(2720),o=i(94151),l=i.n(o);var c=e=>{let{sipConfig:n={},enableDebug:i=!1,onRegistrationStatus:s=()=>{},onUaReady:r=()=>{}}=e;const o=(0,t.useRef)(null);return(0,t.useEffect)(()=>{if(!n||!n.extension||!n.sip_password||!n.sip_domain)return void(s&&s("missing-config"));try{if(window.sipUA&&"object"===typeof window.sipUA&&window.sipUA.isRegistered&&window.sipUA.isRegistered()){s&&s("registered");try{r&&r(window.sipUA)}catch(p){console.warn("onUaReady failed",p)}return}}catch(p){}const e=n.ws_path||"/ws",t=n.ws_port||(!1!==n.wss?8089:8088),c=!1!==n.wss?"wss":"ws",a="".concat(c,"://").concat(n.sip_domain,":").concat(t).concat(e),d="sip:".concat(n.extension,"@").concat(n.sip_domain);let u=null,g=!1;const h=()=>{u&&(clearTimeout(u),u=null)},v=()=>{if(g)return;g=!0,console.warn("SipRegistration: attempting fallback to same-origin websocket");const n="https:"===window.location.protocol?"wss":"ws",i="".concat(n,"://").concat(window.location.host).concat(e);f(i,!1)},f=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{if(o.current){try{o.current.stop()}catch(p){}o.current=null}const c=(e=>({sockets:[e],uri:d,password:n.sip_password,register:!0,session_timers:!1,register_expires:n.register_expires||600,pcConfig:{iceServers:n.iceServers||[{urls:"stun:stun.l.google.com:19302"}]}}))(new(l().WebSocketInterface)(e));i&&l().debug.enable("JsSIP:*");const a=new(l().UA)(c);o.current=a,window.sipUA=a,a.on("connecting",()=>s&&s("connecting")),a.on("connected",()=>s&&s("connected")),a.on("registered",()=>{h(),s&&s("registered");try{r&&r(a)}catch(p){console.warn("onUaReady failed",p)}}),a.on("unregistered",()=>s&&s("unregistered")),a.on("registrationFailed",e=>{console.warn("JsSIP registration failed",e),s&&s("failed")}),a.on("newRTCSession",e=>{const n=e.session;n.on("ended",()=>console.debug("session ended",n)),n.on("failed",()=>console.debug("session failed",n))}),a.start(),s&&s("connecting"),h(),u=setTimeout(()=>{console.warn("SipRegistration: connection timeout; no registration yet"),t&&v()},n.connection_timeout_ms||5e3)}catch(c){console.error("Failed to initialize JsSIP UA with",e,c),s&&s("failed"),g||e===a||v()}};return f(a,!0),()=>{try{o.current&&(o.current.stop(),o.current=null)}catch(p){}}},[JSON.stringify(n)]),null},a=i(44414);var d=e=>{let{session:n}=e;const i=(0,t.useRef)(null);return(0,t.useEffect)(()=>{if(!n||!i.current)return;(()=>{try{const e=n.connection;if(!e)return;const t=e.getRemoteStreams?e.getRemoteStreams():[];if(t&&t.length)return i.current.srcObject=t[0],void i.current.play().catch(()=>{});const s=e.getReceivers?e.getReceivers():[];if(s.length){const e=new MediaStream;s.forEach(n=>{n.track&&e.addTrack(n.track)}),i.current.srcObject=e,i.current.play().catch(()=>{})}}catch(e){console.warn("Failed to attach remote audio",e)}})();const e=e=>{try{i.current.srcObject=e.stream,i.current.play().catch(()=>{})}catch(n){console.warn("onaddstream attach failed",n)}};try{n.connection&&n.connection.addEventListener&&n.connection.addEventListener("addstream",e)}catch(t){}return()=>{try{n.connection&&n.connection.removeEventListener&&n.connection.removeEventListener("addstream",e)}catch(t){}}},[n]),(0,a.jsx)("audio",{ref:i,style:{width:"100%"},controls:!0,autoPlay:!0})};var u=()=>{var e,n,i,o,l,u;const[g,h]=(0,t.useState)(""),[v,f]=(0,t.useState)(!1),[p,x]=(0,t.useState)(null),[m,j]=(0,t.useState)([]),[w,y]=(0,t.useState)([]),b=(0,t.useRef)(null),[S,C]=(0,t.useState)("disconnected"),[_,I]=(0,t.useState)(null),[A,k]=(0,t.useState)(null),[R,U]=(0,t.useState)(null),[$,E]=(0,t.useState)(null),[T,z]=(0,t.useState)(null),[D,P]=(0,t.useState)(null),[F,L]=(0,t.useState)(null),M=async()=>{x(null);try{const e=await(async()=>{if(g)return g;try{const e=await(0,r.H2)("/v1/user/details","GET"),n=e.user||e.data||e;if(n&&n.businessId)return h(n.businessId),n.businessId}catch(e){}return null})();if(!e)return x("Business ID not available"),j([]),void y([]);f(!0);const n=await(0,r.H2)("/asterisk/livecalls/".concat(encodeURIComponent(e)),"GET"),i=Array.isArray(n.liveCalls)?n.liveCalls:[],t=Array.isArray(n.logicalCalls)?n.logicalCalls:[];j(i),y(t)}catch(i){var e,n;console.error("CallMonitor fetch failed",i),x((null===i||void 0===i||null===(e=i.response)||void 0===e||null===(n=e.data)||void 0===n?void 0:n.message)||i.message||"Failed to fetch live calls"),j([]),y([])}finally{f(!1)}};(0,t.useEffect)(()=>(M(),b.current=setInterval(()=>{M()},5e3),()=>{b.current&&clearInterval(b.current)}),[]);const O={sip_domain:"pbx.justconnect.biz",extension:"1036",sip_password:"secure_password_1036",ws_port:8089,ws_path:"/ws",wss:!0,iceServers:[{urls:"stun:stun.l.google.com:19302"}]},W=e=>{var n,i;const t=(null===e||void 0===e?void 0:e.assignedAgent)||(null===e||void 0===e?void 0:e.agent);if(t)if("object"===typeof t){if(t.extension)return String(t.extension);if(t.ext)return String(t.ext);if(t.sipExtension)return String(t.sipExtension)}else if("string"===typeof t&&/^\d+$/.test(t))return t;const s=(null===e||void 0===e?void 0:e.channel)||(null===e||void 0===e||null===(n=e.legs)||void 0===n||null===(i=n[0])||void 0===i?void 0:i.channel);if(s&&"string"===typeof s){const e=s.match(/\/(\d+)(?:-|$)/);if(e&&e[1])return e[1]}if(null!==e&&void 0!==e&&e.agent&&"string"===typeof e.agent&&/\d+/.test(e.agent)){const n=e.agent.match(/(\d{3,})/);if(n)return n[1]}return null};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.sK,{children:(0,a.jsx)(s.UF,{children:(0,a.jsx)(s.E$,{children:(0,a.jsxs)(s.W6,{children:[(0,a.jsx)(c,{sipConfig:O,enableDebug:!1,onRegistrationStatus:C,onUaReady:e=>I(e)}),(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,a.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:12},children:[(0,a.jsx)("h3",{style:{margin:0},children:"Call Monitor"}),(0,a.jsx)(s.$X,{color:"registered"===S?"success":"connected"===S?"info":"connecting"===S?"warning":"secondary",children:S})]}),(0,a.jsx)("div",{children:(0,a.jsx)(s.Q_,{color:"primary",onClick:M,disabled:v,children:v?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.JT,{size:"sm"}),"\xa0Refreshing"]}):"Refresh"})})]}),p&&(0,a.jsx)("div",{style:{color:"var(--cui-danger)"},children:p}),(0,a.jsx)("div",{style:{marginTop:12},children:v&&!m.length?(0,a.jsxs)("div",{style:{padding:20},children:[(0,a.jsx)(s.JT,{}),"\xa0Loading live calls..."]}):(0,a.jsx)(a.Fragment,{children:0===m.length?(0,a.jsx)("div",{style:{padding:20},children:(0,a.jsx)(s.$X,{color:"secondary",children:"No active calls"})}):(0,a.jsxs)(s._v,{striped:!0,hover:!0,responsive:!0,children:[(0,a.jsx)(s.wV,{children:(0,a.jsxs)(s.YI,{children:[(0,a.jsx)(s.$s,{children:"Direction"}),(0,a.jsx)(s.$s,{children:"Channel"}),(0,a.jsx)(s.$s,{children:"Status"}),(0,a.jsx)(s.$s,{children:"Duration"}),(0,a.jsx)(s.$s,{children:"DID"}),(0,a.jsx)(s.$s,{children:"Agent"}),(0,a.jsx)(s.$s,{children:"Branch"}),(0,a.jsx)(s.$s,{children:"Raw"}),(0,a.jsx)(s.$s,{children:"Actions"})]})}),(0,a.jsx)(s.jS,{children:m.map((e,n)=>{var i,t,r,o,l;return(0,a.jsxs)(s.YI,{children:[(0,a.jsx)(s.cC,{children:(()=>{const n=(e=>{const n=e.legs&&e.legs[0]||e,i=String((null===n||void 0===n?void 0:n.raw)||(null===e||void 0===e?void 0:e.raw)||"").toLowerCase(),t=Array.isArray((null===n||void 0===n?void 0:n.tokens)||(null===e||void 0===e?void 0:e.tokens))&&((null===n||void 0===n?void 0:n.tokens)||(null===e||void 0===e?void 0:e.tokens))||[],s=/^\+?\d{7,15}$/,r=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i,o=t.filter(e=>"string"===typeof e&&s.test(e)),l=t.filter(e=>"string"===typeof e&&r.test(e));return o.length>0&&o.length>=1?"Outgoing":l.length>0&&0===o.length||/\bincoming\b/i.test(i)||/from-external/i.test(i)?"Inbound":/\boutgoing\b/i.test(i)||/outbound/i.test(i)||/\bdial\b/i.test(i)||o.length>0?"Outgoing":"Inbound"})(e);return(0,a.jsx)(s.$X,{color:"Outgoing"===n?"primary":"Inbound"===n?"info":"secondary",children:n})})()}),(0,a.jsx)(s.cC,{children:e.channel||"-"}),(0,a.jsx)(s.cC,{children:(0,a.jsx)(s.$X,{color:"up"===String(e.status||"").toLowerCase()?"success":"ring"===String(e.status||"").toLowerCase()?"warning":"secondary",children:e.status||"-"})}),(0,a.jsx)(s.cC,{children:e.duration||"-"}),(0,a.jsx)(s.cC,{children:(null===(i=e.did)||void 0===i?void 0:i.number)||(null===(t=e.tokens)||void 0===t?void 0:t[3])||"-"}),(0,a.jsx)(s.cC,{children:(null===(r=e.assignedAgent)||void 0===r?void 0:r.name)||(null===(o=e.assignedAgent)||void 0===o?void 0:o.email)||"-"}),(0,a.jsx)(s.cC,{children:(null===(l=e.branch)||void 0===l?void 0:l.branchName)||"-"}),(0,a.jsx)(s.cC,{style:{maxWidth:400,overflow:"hidden",textOverflow:"ellipsis"},children:e.raw||"-"}),(0,a.jsx)(s.cC,{children:(0,a.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,a.jsx)(s.Q_,{size:"sm",color:"info",onClick:()=>(async e=>{const n=W(e);if(!n)return void alert("Could not determine extension to monitor for this call.");if(!_)return void alert("SIP UA not ready; please wait for registration.");const i=_.configuration&&_.configuration.uri&&_.configuration.uri.host||O.sip_domain||"",t="*90".concat(n),s=i?"sip:".concat(t,"@").concat(i):"sip:".concat(t);try{const n={mediaConstraints:{audio:!0,video:!1},pcConfig:{iceServers:O.iceServers}},i=_.call(s,n);k(i),U(e),i.on&&i.on("ended",()=>{k(null),U(null)}),i.on&&i.on("failed",()=>{k(null),U(null)})}catch(r){console.error("Monitor failed",r),alert("Monitor failed: "+String(r))}})(e),disabled:"registered"!==S||!_,title:"registered"===S&&_?"Monitor":"Disabled: waiting for SIP registration (".concat(S,")"),children:"Monitor"}),(0,a.jsx)(s.Q_,{size:"sm",color:"warning",onClick:()=>(async e=>{const n=W(e);if(!n)return void alert("Could not determine extension to whisper for this call.");if(!_)return void alert("SIP UA not ready; please wait for registration.");const i=_.configuration&&_.configuration.uri&&_.configuration.uri.host||O.sip_domain||"",t="*91".concat(n),s=i?"sip:".concat(t,"@").concat(i):"sip:".concat(t);try{const n={mediaConstraints:{audio:!0,video:!1},pcConfig:{iceServers:O.iceServers}},i=_.call(s,n);E(i),z(e),i.on&&i.on("ended",()=>{E(null),z(null)}),i.on&&i.on("failed",()=>{E(null),z(null)})}catch(r){console.error("Whisper failed",r),alert("Whisper failed: "+String(r))}})(e),disabled:"registered"!==S||!_,title:"registered"===S&&_?"Whisper":"Disabled: waiting for SIP registration (".concat(S,")"),children:"Whisper"}),(0,a.jsx)(s.Q_,{size:"sm",color:"success",onClick:()=>(async e=>{const n=W(e);if(!n)return void alert("Could not determine extension to barge for this call.");if(!_)return void alert("SIP UA not ready; please wait for registration.");const i=_.configuration&&_.configuration.uri&&_.configuration.uri.host||O.sip_domain||"",t="*92".concat(n),s=i?"sip:".concat(t,"@").concat(i):"sip:".concat(t);try{const n={mediaConstraints:{audio:!0,video:!1},pcConfig:{iceServers:O.iceServers}},i=_.call(s,n);P(i),L(e),i.on&&i.on("ended",()=>{P(null),L(null)}),i.on&&i.on("failed",()=>{P(null),L(null)})}catch(r){console.error("Barge failed",r),alert("Barge failed: "+String(r))}})(e),disabled:"registered"!==S||!_,title:"registered"===S&&_?"Barge":"Disabled: waiting for SIP registration (".concat(S,")"),children:"Barge"})]})})]},"".concat(e.channel||e.groupId||n,"-").concat(n))})})]})})})]})})})}),A&&(0,a.jsxs)("div",{style:{position:"fixed",bottom:16,right:16,width:360,background:"white",padding:12,borderRadius:8,boxShadow:"0 6px 18px rgba(0,0,0,0.1)"},children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,a.jsxs)("div",{children:["Monitoring ",(0,a.jsx)("strong",{children:(null===R||void 0===R||null===(e=R.assignedAgent)||void 0===e?void 0:e.name)||(null===R||void 0===R||null===(n=R.assignedAgent)||void 0===n?void 0:n.email)||(null===R||void 0===R?void 0:R.agent)||"agent"})]}),(0,a.jsx)("div",{children:(0,a.jsx)(s.Q_,{size:"sm",color:"danger",onClick:()=>{try{A.terminate()}catch(e){}k(null),U(null)},children:"Hangup"})})]}),(0,a.jsx)("div",{style:{marginTop:8},children:(0,a.jsx)(d,{session:A})})]}),$&&(0,a.jsxs)("div",{style:{position:"fixed",bottom:16,right:16,width:360,background:"white",padding:12,borderRadius:8,boxShadow:"0 6px 18px rgba(0,0,0,0.1)",zIndex:1100},children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,a.jsxs)("div",{children:["Whispering to ",(0,a.jsx)("strong",{children:(null===T||void 0===T||null===(i=T.assignedAgent)||void 0===i?void 0:i.name)||(null===T||void 0===T||null===(o=T.assignedAgent)||void 0===o?void 0:o.email)||(null===T||void 0===T?void 0:T.agent)||"agent"})]}),(0,a.jsx)("div",{children:(0,a.jsx)(s.Q_,{size:"sm",color:"danger",onClick:()=>{try{$.terminate()}catch(e){}E(null),z(null)},children:"Hangup"})})]}),(0,a.jsx)("div",{style:{marginTop:8},children:(0,a.jsx)(d,{session:$})})]}),D&&(0,a.jsxs)("div",{style:{position:"fixed",bottom:16,right:16,width:360,background:"white",padding:12,borderRadius:8,boxShadow:"0 6px 18px rgba(0,0,0,0.1)",zIndex:1090},children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,a.jsxs)("div",{children:["Barging into ",(0,a.jsx)("strong",{children:(null===F||void 0===F||null===(l=F.assignedAgent)||void 0===l?void 0:l.name)||(null===F||void 0===F||null===(u=F.assignedAgent)||void 0===u?void 0:u.email)||(null===F||void 0===F?void 0:F.agent)||"agent"})]}),(0,a.jsx)("div",{children:(0,a.jsx)(s.Q_,{size:"sm",color:"danger",onClick:()=>{try{D.terminate()}catch(e){}P(null),L(null)},children:"Hangup"})})]}),(0,a.jsx)("div",{style:{marginTop:8},children:(0,a.jsx)(d,{session:D})})]})]})}}}]);