"use strict";(self.webpackChunk_coreui_coreui_free_react_admin_template=self.webpackChunk_coreui_coreui_free_react_admin_template||[]).push([[3944],{73834:function(){},93944:function(e,t,n){n.r(t);var s=n(9950),i=n(49911),a=n(2720),o=(n(73834),n(44414));t.default=()=>{var e,t;const[n,r]=(0,s.useState)([]),[d,l]=(0,s.useState)(!1),[c,m]=(0,s.useState)(1),[u]=(0,s.useState)(50),[p,g]=(0,s.useState)(localStorage.getItem("businessId")||""),[h,y]=(0,s.useState)(new Set),[v,x]=(0,s.useState)(null),[b,f]=(0,s.useState)(!1),[j,I]=(0,s.useState)(!1),[N,_]=(0,s.useState)({node:"",voice:"",active:!0,options:[{key:"1",type:"node",target:"",agentId:"",voice:""}],menu:""}),[S,A]=(0,s.useState)([]),[w,k]=(0,s.useState)(!1),[C,E]=(0,s.useState)(null),[R,T]=(0,s.useState)([]),[O,V]=(0,s.useState)({}),[L,F]=(0,s.useState)(null),[U,H]=(0,s.useState)(null),[P,D]=(0,s.useState)(null);(0,s.useEffect)(()=>{(async()=>{if(!p)try{const t=await(0,a.H2)("/v1/user/details","GET"),n=t.user||t.data||t;if(n&&n.businessId){g(n.businessId);try{localStorage.setItem("businessId",n.businessId)}catch(e){}}}catch(t){}})()},[]),(0,s.useEffect)(()=>{p&&(async()=>{const e=p||localStorage.getItem("businessId")||"";if(e)try{const t=await(0,a.H2)("/departments/business/".concat(e),"GET");let n=[];Array.isArray(t)?n=t:null!==t&&void 0!==t&&t.data&&Array.isArray(t.data)?n=t.data:null!==t&&void 0!==t&&t.departments&&Array.isArray(t.departments)?n=t.departments:t&&"object"===typeof t&&t.name&&(n=[t]),A(n)}catch(t){console.error("Failed to fetch departments",t),A([])}})()},[p]);const $=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;const t=p||localStorage.getItem("businessId")||"";if(!t)return r([]),void l(!1);l(!0);try{const i="/ivrs/business/".concat(t,"?page=").concat(e,"&limit=").concat(u),o=await(0,a.H2)(i,"GET");if(o&&o.success){var n;let e=[];e=Array.isArray(o.files)?o.files:Array.isArray(o.data)?o.data:Array.isArray(null===(n=o.data)||void 0===n?void 0:n.files)?o.data.files:Array.isArray(o)?o:[];const t=e.map(e=>{var t,n,s;return{...e,name:e.name||e.title||e._id||"",voice:(null===(t=e.menu)||void 0===t?void 0:t.voice)||(null===(n=e.menu)||void 0===n?void 0:n.welcome)||e.voice||e.welcome||e.generatedText||"",options:Array.isArray(e.options)?e.options:(null===(s=e.menu)||void 0===s?void 0:s.options)||[],createdAt:e.createdAt||e.uploadedAt||e.updatedAt||e.created||null,status:e.status||e.ivrStatus||e.state||"unknown",raw:e}});if(r(t),o.pagination&&o.pagination.page)try{m(o.pagination.page)}catch(s){}}else r([])}catch(i){console.error("Failed to fetch IVRs",i),r([])}finally{l(!1)}};(0,s.useEffect)(()=>{$(c)},[c]);const q=s.useMemo(()=>{try{return Array.from(new Set(n.map(e=>(e.node||e.name||e.title||"").toString()).filter(Boolean)))}catch(e){return[]}},[n]),B=async e=>{if(e)try{var t;const n=await(0,a.H2)("/departments/".concat(e,"/members"),"GET");let s=[];s=Array.isArray(n)?n:Array.isArray(n.data)?n.data:Array.isArray(null===(t=n.data)||void 0===t?void 0:t.data)?n.data.data:null!==n&&void 0!==n&&n.members&&Array.isArray(n.members)?n.members:[];const i=s.map(e=>{var t;const n=e.user||{},s=e.userId||(null===(t=e.user)||void 0===t?void 0:t._id)||e._id||e.id;return{_id:s,id:s,name:n.name||[n.firstName,n.lastName].filter(Boolean).join(" ")||n.email||n.fullName||s,email:n.email,phone:e.phone||n.phone||n.mobile||"",didNumber:e.didNumber||"",didExtension:e.didExtension||e.did_extension||"",role:e.role||n.role||"",raw:e}});return V(t=>({...t,[e]:i})),i}catch(n){return console.error("Failed to fetch department members",n),V(t=>({...t,[e]:[]})),[]}},M=()=>{f(!1),x(null)},J=e=>{if(!e)return"-";try{return new Date(e).toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(t){return e}};return(0,o.jsxs)(i.E$,{className:"mb-4",children:[(0,o.jsxs)(i.V0,{className:"d-flex justify-content-between align-items-center",children:[(0,o.jsx)("span",{children:"IVR Management"}),(0,o.jsxs)("div",{children:[(0,o.jsx)("button",{className:"btn btn-sm btn-success me-2",onClick:()=>{E(null),_({node:"",voice:"",active:!0,options:[{key:"1",type:"node",target:"",agentId:"",voice:""}],menu:""}),I(!0)},children:"Add"}),(0,o.jsx)("button",{className:"btn btn-sm btn-outline-danger me-2",onClick:async()=>{const e=p||localStorage.getItem("businessId")||"";if(e&&window.confirm("Delete ALL IVRs for this business? This cannot be undone."))try{k(!0);const t="/ivrs/business/".concat(e),n=await(0,a.H2)(t,"DELETE");n&&n.success?(console.log("Deleted all IVRs",n),$(1)):console.error("Failed to delete IVRs",n)}catch(t){console.error("Error deleting IVRs",t)}finally{k(!1)}},disabled:w||d,children:"Delete all"}),(0,o.jsx)("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:()=>$(1),disabled:d,children:"Refresh"}),(0,o.jsx)("button",{className:"btn btn-sm btn-outline-secondary me-2",onClick:()=>m(e=>Math.max(1,e-1)),disabled:1===c||d,children:"Prev"}),(0,o.jsxs)("span",{className:"mx-2",children:["Page ",c]}),(0,o.jsx)("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>m(e=>e+1),disabled:d,children:"Next"})]})]}),(0,o.jsxs)(i.W6,{children:[!p&&(0,o.jsx)("div",{className:"mb-3",children:(0,o.jsxs)("div",{className:"alert alert-warning",children:["Missing ",(0,o.jsx)("code",{children:"businessId"})," in localStorage. Set it to view IVRs."]})}),(0,o.jsxs)(i.zS,{visible:b,onClose:M,alignment:"center",children:[(0,o.jsx)(i.E4,{children:(0,o.jsx)(i.lb,{children:"IVR Details"})}),(0,o.jsx)(i.Tc,{children:v?(0,o.jsxs)("div",{children:[(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)("strong",{children:"Name:"})," ",v.name||v.title||"-"]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)("strong",{children:"Virtual Number:"})," ",v.virtualNumber||v.number||"-"]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)("strong",{children:"Created By:"})," ",(null===(e=v.createdBy)||void 0===e?void 0:e.email)||(null===(t=v.createdBy)||void 0===t?void 0:t.name)||"-"]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)("strong",{children:"Created At:"})," ",J(v.createdAt||v.created)]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)("strong",{children:"Status:"})," ",(0,o.jsx)(i.$X,{color:v.active?"success":"secondary",children:v.active?"Active":"Inactive"})]}),(0,o.jsx)("hr",{}),(0,o.jsx)("h6",{children:"Routing / Menu"}),(0,o.jsx)("pre",{style:{whiteSpace:"pre-wrap"},children:JSON.stringify(v.menu||v.routing||v,null,2)})]}):(0,o.jsx)("div",{children:"No item selected"})}),(0,o.jsx)(i.If,{children:(0,o.jsx)(i.Q_,{color:"secondary",onClick:M,children:"Close"})})]}),(0,o.jsxs)(i.zS,{visible:j,onClose:()=>{I(!1),E(null)},alignment:"center",size:"xl",children:[(0,o.jsx)(i.E4,{children:(0,o.jsx)(i.lb,{children:C?"Edit IVR (".concat(C,")"):"Add IVR"})}),(0,o.jsxs)(i.Tc,{children:[(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"Node (identifier)"}),(0,o.jsx)("input",{className:"form-control",value:N.node,placeholder:"e.g. menu, sales_menu",onChange:e=>_({...N,node:e.target.value})})]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"Voice Text"}),(0,o.jsx)("input",{className:"form-control",value:N.voice,placeholder:"e.g. Welcome to Acme.",onChange:e=>_({...N,voice:e.target.value})})]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsxs)("label",{className:"form-label",children:["Options (press ",">"," target)"]}),N.options.map((e,t)=>(0,o.jsxs)("div",{className:"d-flex mb-2",children:[(0,o.jsx)("input",{style:{width:80},className:"form-control me-2",value:e.key,onChange:e=>{const n=[...N.options];n[t]={...n[t],key:e.target.value},_({...N,options:n})}}),(0,o.jsxs)("select",{className:"form-select me-2",style:{width:140},value:e.type||"node",onChange:e=>{const n=[...N.options];n[t]={...n[t],type:e.target.value,target:""},_({...N,options:n})},children:[(0,o.jsx)("option",{value:"node",children:"node"}),(0,o.jsx)("option",{value:"dept",children:"dept"})]}),"dept"===e.type?(0,o.jsxs)("div",{className:"me-2 d-flex",style:{gap:8},children:[(0,o.jsxs)("select",{className:"form-select",value:e.target||"",onChange:e=>{const n=e.target.value,s=[...N.options];s[t]={...s[t],target:n,agentId:""},_({...N,options:s}),B(n)},children:[(0,o.jsx)("option",{value:"",children:"Select department"}),S.map(e=>(0,o.jsx)("option",{value:e._id||e.id,children:e.name||e.departmentName||e.title||e.slug||e._id},e._id||e.id))]}),(0,o.jsxs)("select",{className:"form-select",value:e.agentId||"",onChange:e=>{const n=[...N.options];n[t]={...n[t],agentId:e.target.value},_({...N,options:n})},children:[(0,o.jsx)("option",{value:"",children:"Select agent (optional)"}),(()=>{const t=S.find(t=>t._id===e.target||t.id===e.target);if(!t)return null;const n=O[t._id]||O[t.id]||[],s=t.departmentHead||t.head||t.userId||t.departmentHeadId||t.department_head,i=n.find(e=>e._id===s||e.id===s);return(i?[i,...n.filter(e=>e._id!==i._id)]:n).map(e=>(0,o.jsx)("option",{value:e._id||e.id,children:e.name||e.email||e._id},e._id||e.id))})()]})]}):q.length>0?(0,o.jsxs)("select",{className:"form-select me-2",value:e.target||"",onChange:e=>{const n=[...N.options];n[t]={...n[t],target:e.target.value},_({...N,options:n})},children:[(0,o.jsx)("option",{value:"",children:"Select node"}),q.map(e=>(0,o.jsx)("option",{value:e,children:e},e))]}):(0,o.jsx)("input",{className:"form-control me-2",value:e.target,onChange:e=>{const n=[...N.options];n[t]={...n[t],target:e.target.value},_({...N,options:n})},placeholder:"e.g. sales_menu"}),(0,o.jsx)("input",{style:{width:200},className:"form-control me-2",value:e.voice||"",onChange:e=>{const n=[...N.options];n[t]={...n[t],voice:e.target.value},_({...N,options:n})},placeholder:"Option voice text (e.g. For sales)"}),(0,o.jsx)("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>{const e=[...N.options];e.splice(t,1),_({...N,options:e})},children:"Remove"})]},t)),(0,o.jsx)("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>_({...N,options:[...N.options,{key:"",type:"node",target:"",agentId:"",voice:""}]}),children:"Add option"})]}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)("label",{className:"form-label",children:"Advanced JSON (optional)"}),(0,o.jsx)("textarea",{className:"form-control",rows:6,value:N.menu,onChange:e=>_({...N,menu:e.target.value}),placeholder:'{"options": {"1":"node:sales_menu"}}'})]}),(0,o.jsxs)("div",{className:"form-check form-switch mb-2",children:[(0,o.jsx)("input",{className:"form-check-input",type:"checkbox",id:"ivrActive",checked:!!N.active,onChange:e=>_({...N,active:e.target.checked})}),(0,o.jsx)("label",{className:"form-check-label",htmlFor:"ivrActive",children:"Active"})]})]}),(0,o.jsxs)(i.If,{children:[(0,o.jsx)(i.Q_,{color:"secondary",onClick:()=>{I(!1),E(null)},children:"Cancel"}),(0,o.jsx)(i.Q_,{color:"primary",onClick:async()=>{const e=p||localStorage.getItem("businessId")||"";if(e)try{const o=Array.isArray(N.options)&&N.options.some(e=>e.key&&(e.target||e.voice));if(C){let r=[];if(o)N.options.forEach(e=>{if(e.key)if("dept"===e.type)if(e.agentId){let t=S.find(t=>t._id===e.target||t.id===e.target);t||(t=S.find(t=>Array.isArray(t.members)&&t.members.find(t=>t._id===e.agentId||t.userId===e.agentId||t.id===e.agentId)));const n=t?t.name||t.departmentName||t.slug||t._id:e.target||"";let s="";if(t&&Array.isArray(t.members)&&t.members.length){const n=t.members.find(t=>t._id===e.agentId||t.userId===e.agentId||t.id===e.agentId);n&&(s=n.didExtension||n.did_extension||n.didNumber||"")}if(!s){const n=(t&&(O[t._id]||O[t.id])||[]).find(t=>t._id===e.agentId||t.id===e.agentId);n&&(s=n.didExtension||n.did_extension||n.didNumber||"")}if(!s){const t=Object.keys(O);for(let n=0;n<t.length&&!s;n++){const i=(O[t[n]]||[]).find(t=>t._id===e.agentId||t.id===e.agentId);i&&(s=i.didExtension||i.did_extension||i.didNumber||"")}}const i="dept:".concat(String(n||"").toLowerCase()).concat(s?":"+String(s):"");r.push({key:e.key,voice:e.voice||"",destination:i})}else{const t=S.find(t=>t._id===e.target||t.id===e.target||t.slug&&t.slug===e.target||t.name&&t.name.toString().toLowerCase()===(e.target||"").toString().toLowerCase()),n=t?t.name||t.departmentName||t.slug||t._id:e.target,s="dept:".concat(String(n||"").toLowerCase());r.push({key:e.key,voice:e.voice||"",destination:s})}else r.push({key:e.key,voice:e.voice||"",destination:"node:".concat(e.target||"")})});else if(N.menu)try{const e=JSON.parse(N.menu);e&&"object"===typeof e&&(Array.isArray(e.options)?r=e.options:e.options&&"object"===typeof e.options&&(r=Object.keys(e.options).map(t=>({key:t,voice:e.options[t].voice||"",destination:e.options[t].destination||e.options[t]}))))}catch(t){N.menu.split(/\r?\n/).map(e=>e.trim()).filter(Boolean).forEach(e=>{const t=e.match(/^(\d+)\s*[:=]\s*(.+)$/);t&&r.push({key:t[1],voice:"",destination:t[2].trim()})})}const d={businessId:e,node:C,menu:{voice:N.voice||"",options:r}};try{const t=await(0,a.H2)("/ivr/update/save/".concat(encodeURIComponent(C)),"PUT",d);if(t&&(t.success||t.saved||t.data)){try{const t=await(0,a.H2)("/ivr/update/generate-only/".concat(encodeURIComponent(C)),"PUT",d);console.debug("Enqueued generate-only",t);try{await(0,a.H2)("/ivr/update/upload-only/".concat(encodeURIComponent(C)),"PUT",{businessId:e}),console.debug("Enqueued upload-only for",C)}catch(n){console.error("Failed to enqueue upload-only",n)}}catch(s){console.error("Failed to enqueue generate-only",s)}I(!1),E(null),_({node:"",prompt:"",active:!0,options:[{key:"1",type:"node",target:"",agentId:""}],menu:""}),$(1)}else console.error("Failed to save IVR metadata",t)}catch(i){console.error("Failed to save IVR metadata",i)}}else{let r={};if(o)N.options.forEach(e=>{if(e.key)if("dept"===e.type)if(e.agentId){let t=S.find(t=>t._id===e.target||t.id===e.target);t||(t=S.find(t=>Array.isArray(t.members)&&t.members.find(t=>t._id===e.agentId||t.userId===e.agentId||t.id===e.agentId)));const n=t?t.name||t.departmentName||t.slug||t._id:e.target||"";let s="";if(t&&Array.isArray(t.members)&&t.members.length){const n=t.members.find(t=>t._id===e.agentId||t.userId===e.agentId||t.id===e.agentId);n&&(s=n.didExtension||n.did_extension||n.didNumber||"")}if(!s){const n=(t&&(O[t._id]||O[t.id])||[]).find(t=>t._id===e.agentId||t.id===e.agentId);n&&(s=n.didExtension||n.did_extension||n.didNumber||"")}if(!s){const t=Object.keys(O);for(let n=0;n<t.length&&!s;n++){const i=(O[t[n]]||[]).find(t=>t._id===e.agentId||t.id===e.agentId);i&&(s=i.didExtension||i.did_extension||i.didNumber||"")}}const i="dept:".concat(String(n||"").toLowerCase()).concat(s?":"+String(s):"");r[e.key]={destination:i,voice:e.voice||""}}else{const t=S.find(t=>t._id===e.target||t.id===e.target||t.slug&&t.slug===e.target||t.name&&t.name.toString().toLowerCase()===(e.target||"").toString().toLowerCase()),n=t?t.name||t.departmentName||t.slug||t._id:e.target,s="dept:".concat(String(n||"").toLowerCase());r[e.key]={destination:s,voice:e.voice||""}}else r[e.key]={destination:"node:".concat(e.target||""),voice:e.voice||""}});else if(N.menu)try{const e=JSON.parse(N.menu);e&&"object"===typeof e&&(r=e.options&&"object"===typeof e.options?e.options:e)}catch(t){N.menu.split(/\r?\n/).map(e=>e.trim()).filter(Boolean).forEach(e=>{const t=e.match(/^(\d+)\s*[:=]\s*(.+)$/);t&&(r[t[1]]=t[2].trim())})}const d=N.node||"menu_".concat(Date.now());let l=[];Array.isArray(r)?l=r:r&&"object"===typeof r&&(l=Object.keys(r).map(e=>{const t=r[e];return"string"===typeof t?{key:e,voice:"",destination:t}:{key:e,voice:(null===t||void 0===t?void 0:t.voice)||"",destination:(null===t||void 0===t?void 0:t.destination)||t}}));const c={businessId:e,node:d,menu:{voice:N.voice||"",options:l}};try{const t=await(0,a.H2)("/ivr/save","POST",c);if(t&&(t.success||t.saved||t.data)){try{const t=await(0,a.H2)("/ivr/generate-only","POST",c);console.debug("Enqueued generate-only",t);try{await(0,a.H2)("/ivr/upload-only","POST",{name:d,businessId:e}),console.debug("Enqueued upload-only for",d)}catch(n){console.error("Failed to enqueue upload-only",n)}}catch(s){console.error("Failed to enqueue generate-only",s)}I(!1),_({node:"",prompt:"",active:!0,options:[{key:"1",type:"node",target:"",agentId:""}],menu:""}),$(1)}else console.error("Failed to save IVR metadata",t)}catch(i){console.error("Error creating IVR metadata",i)}}}catch(i){console.error("Error saving IVR",i)}},children:C?"Save":"Create"})]})]}),d?(0,o.jsx)("div",{className:"text-center py-4",children:(0,o.jsx)(i.JT,{})}):0===n.length?(0,o.jsx)("div",{className:"text-center py-3",children:"No IVRs found"}):(0,o.jsxs)(i._v,{hover:!0,responsive:!0,className:"table-sm compact-table branches-table",style:{tableLayout:"auto"},children:[(0,o.jsx)(i.wV,{children:(0,o.jsxs)(i.YI,{children:[(0,o.jsx)(i.$s,{style:{width:"25%"},children:"NAME"}),(0,o.jsx)(i.$s,{style:{width:"30%"},children:"VOICE"}),(0,o.jsx)(i.$s,{style:{width:"10%"},children:"OPTIONS"}),(0,o.jsx)(i.$s,{style:{width:"15%"},children:"CREATED AT"}),(0,o.jsx)(i.$s,{style:{width:"10%"},children:"ACTION"}),(0,o.jsx)(i.$s,{className:"text-center",style:{width:"10%"},children:"STATUS"})]})}),(0,o.jsx)(i.jS,{children:n.map(e=>(0,o.jsxs)(s.Fragment,{children:[(0,o.jsxs)(i.YI,{onClick:()=>(e=>{const t=new Set(h);t.has(e)?t.delete(e):t.add(e),y(t)})(e._id||e.id||e.name),style:{cursor:"pointer",backgroundColor:h.has(e._id||e.id||e.name)?"#f8f9fa":"transparent"},role:"button",tabIndex:0,children:[(0,o.jsx)(i.cC,{className:"align-middle",children:(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,o.jsx)("div",{style:{fontSize:"1.1rem",marginRight:10},children:h.has(e._id||e.id||e.name)?"\u25bc":"\u25b6"}),(0,o.jsx)("div",{className:"agent-name",children:e.name||"-"})]})}),(0,o.jsx)(i.cC,{className:"align-middle",children:(0,o.jsx)("div",{className:"manager-email",children:e.voice||"-"})}),(0,o.jsx)(i.cC,{className:"align-middle",children:(0,o.jsx)("div",{className:"agent-number",children:Array.isArray(e.options)?e.options.length:e.totalMenuOptions||"-"})}),(0,o.jsx)(i.cC,{className:"align-middle",children:(0,o.jsx)("div",{className:"department-name",children:J(e.createdAt)})}),(0,o.jsx)(i.cC,{className:"align-middle",children:(0,o.jsx)("div",{children:(0,o.jsx)("button",{className:"btn btn-sm btn-warning",onClick:t=>{t.stopPropagation(),(async e=>{var t,n;const s=e.name||e.node||e._id,i=e.voice||(null===(t=e.menu)||void 0===t?void 0:t.voice)||"",a=(Array.isArray(e.options)?e.options:(null===(n=e.menu)||void 0===n?void 0:n.options)||[]).map(e=>{const t=(e.destination||e.destinationType||"").toString().split(":"),n=t[0]||"node",s=t.slice(1);if("agent"===n){const t=s.join(":")||"";return{key:e.key||e._id||"",type:"dept",target:"",agentId:t||"",voice:e.voice||e.text||""}}if("dept"===n){const t=s[0]||"",n=s[1]||"",i=S.find(e=>e._id===t||e.id===t||e.name&&e.name.toString().toLowerCase()===t.toString().toLowerCase()||e.slug&&e.slug===t),a=i?i._id||i.id:t;let o="";if(n&&i){const e=Array.isArray(i.members)?i.members.find(e=>String(e.didExtension||e.did_extension||e.didNumber||"").toString()===String(n)):null;if(e&&(o=e._id||e.id||e.userId||""),!o){const e=(O[i._id]||O[i.id]||[]).find(e=>String(e.didExtension||e.did_extension||e.didNumber||"").toString()===String(n));e&&(o=e._id||e.id||"")}}return{key:e.key||e._id||"",type:"dept",target:a||"",agentId:o||"",voice:e.voice||e.text||"",ext:n||""}}return{key:e.key||e._id||"",type:"node",target:s.join(":")||"",agentId:"",voice:e.voice||e.text||""}});_({node:s,voice:i,active:"active"===e.status||"on"===e.ivrStatus||"on"===e.status,options:a.length?a:[{key:"1",type:"node",target:"",agentId:"",voice:""}],menu:""}),E(s),I(!0),a.forEach(async(e,t)=>{if("dept"===e.type&&e.target){const n=await B(e.target);if(e.ext){const s=(Array.isArray(n)?n:[]).find(t=>String(t.didExtension||t.did_extension||t.didNumber||"").toString()===String(e.ext));s&&_(e=>{const n=Array.isArray(e.options)?[...e.options]:[];return n[t]?(n[t]={...n[t],agentId:s._id||s.id||s.userId||""},{...e,options:n}):e})}}})})(e)},children:"Edit"})})}),(0,o.jsx)(i.cC,{className:"text-center align-middle",children:(0,o.jsx)(i.$X,{color:"active"===e.status||"on"===e.status?"success":"secondary",children:e.status||"-"})})]}),h.has(e._id||e.id||e.name)&&(0,o.jsx)(i.YI,{children:(0,o.jsx)(i.cC,{colSpan:6,style:{padding:"1rem",backgroundColor:"#f8f9fa"},children:(0,o.jsxs)("div",{className:"d-flex justify-content-between align-items-start",children:[(0,o.jsxs)("div",{style:{flex:1},children:[(0,o.jsx)("h6",{className:"mb-2",children:"IVR Details"}),(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsx)("strong",{children:"File:"})," ",e.fileName||e.audioFile||e._id||"-",(e.fileName||e.audioFile||e._id)&&(0,o.jsx)(o.Fragment,{children:P===(e._id||e.id||e.fileName||e.audioFile)?(0,o.jsx)("button",{className:"btn btn-sm btn-outline-danger ms-2",onClick:e=>{e.stopPropagation(),(()=>{if(U){try{U.pause()}catch(e){}try{window.URL.revokeObjectURL(L)}catch(e){}}H(null),F(null),D(null)})()},children:"Stop"}):(0,o.jsx)("button",{className:"btn btn-sm btn-outline-primary ms-2",onClick:t=>{t.stopPropagation(),(async e=>{try{const n=p||localStorage.getItem("businessId")||"",s=e._id||e.id;let i="";if(s)i="/ivrs/download/".concat(encodeURIComponent(s),"?businessId=").concat(encodeURIComponent(n));else{const t=e.fileName||e.audioFile;if(!t)return;i="/ivr/download/".concat(encodeURIComponent(t),"?businessId=").concat(encodeURIComponent(n))}const o=await(0,a.H2)(i,"GET",null,{responseType:"arraybuffer"});if(!o)return;const r=e.mimeType||"audio/wav",d=new Blob([o],{type:r}),l=window.URL.createObjectURL(d);if(U){try{U.pause()}catch(t){}try{window.URL.revokeObjectURL(L)}catch(t){}}const c=new Audio(l);F(l),H(c),D(e._id||e.id||name),c.play().catch(e=>{console.error("Audio play failed",e)}),c.onended=()=>{try{window.URL.revokeObjectURL(l)}catch(t){}F(null),H(null),D(null)}}catch(n){console.error("Failed to play IVR file",n)}})(e)},children:"Play"})})]}),(0,o.jsx)("div",{className:"mb-2",children:(0,o.jsx)("strong",{children:"Menu Options:"})}),(0,o.jsx)("div",{children:Array.isArray(e.options)&&e.options.length>0?e.options.map(e=>(0,o.jsxs)("div",{className:"mb-1 p-2",style:{backgroundColor:"#fff",border:"1px solid #e0e0e0",borderRadius:"4px"},children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"Key:"})," ",e.key]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"Voice:"})," ",e.voice||e.text||"-"]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"Destination:"})," ",e.destination||e.destinationType||e.destination||"-"]})]},e._id||e.key)):(0,o.jsx)("pre",{style:{whiteSpace:"pre-wrap"},children:JSON.stringify(e.menu||e.raw||{},null,2)})})]}),(0,o.jsx)("div",{className:"ms-3",children:(0,o.jsx)("div",{children:(0,o.jsx)(i.Q_,{size:"sm",color:"primary",onClick:t=>{t.stopPropagation(),x(e),f(!0)},children:"Details"})})})]})})})]},e._id||e.id||e.name))})]})]})]})}}}]);